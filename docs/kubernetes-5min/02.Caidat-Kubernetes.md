## C√†i ƒëƒÉt Kubernetes 

### 1. M√¥i tr∆∞·ªùng
- Ubuntu 16.04 - 64 bit (3 node: 01 Node k8s-master, 02 node k8s-node1 & k8s-node2)
- Docker version Docker version 1.13.1, build 092cba3
- Kubernetes version v1.9.2

`L∆∞u √Ω`: T√†i li·ªáu th·ª±c h√†nh n√†y c√≥ √Ω nghƒ©a nh·∫•t v·ªõi c√°c phi√™n b·∫£n ƒë∆∞·ª£c k·ªÉ t√™n ·ªü tr√™n, c√°c phi√™n b·∫£n kh√°c ho·∫∑c c≈© h∆°n c·ªßa t·ª´ng th√†nh ph·∫ßn s·∫Ω c·∫ßn c√≥ h∆∞·ªõng d·∫´n kh√°c ho·∫∑c ch∆∞a ch·∫Øc ch·∫Øn c√°c b∆∞·ªõc th·ª±c hi·ªán nh∆∞ t√†i li·ªáu n√†y.


### 2. M√¥ h√¨nh & IP Planning

#### 2.1. M√¥ h√¨nh: 

![K8S-topology](../../images/K8S-topology.png)

- File topology online ƒë∆∞·ª£c cung c·∫•p ·ªü [link  n√†y](https://www.draw.io/#G1NmTeK-k590hew0GikQcl_TNiwO1nDjxK)

#### 2.2. IP Planning:

![ip-planning](../../images/ip-planning.png)

- L∆∞u √Ω: M·∫∑c d√π trong b·∫£ng tr√™n ta c√≥ 03 NICs cho m·ªói m√°y nh∆∞ng trong c√°c b∆∞·ªõc h∆∞·ªõng d·∫´n n√†y ta ch·ªâ c·∫ßn s·ª≠ d·ª•ng interface c√≥ d·∫£i `172.16.68.0/24`. C√°c d·∫£i c√≤n l·∫°i l√† do h·∫° t·∫ßng c·ªßa t√¥i v√† t√¥i chu·∫©n b·ªã s·∫µn ƒë·ªÉ cho c√°c m·ª•c ti√™u kh√°c. Do v·∫≠y ƒë·ªÉ l√†m theo LAB n√†y b·∫°n ch·ªâ m·ªói m√°y c√≥ 01 NIC l√† ƒë∆∞·ª£c. H√£y thay l·∫°i IP cho ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng c·ªßa b·∫°n nh√©.
 
### 3. B∆∞·ªõc chu·∫©n b·ªã

ƒê·∫∑t hostname, IP cho t·∫•t c·∫£ c√°c node theo IP Planning
- SSH v·ªõi t√†i kho·∫£n `root` v√† th·ª±c hi·ªán.

#### 3.1. ƒê·∫∑t hostname v√† ip cho node `k8s-master`

- Th·ª±c hi·ªán update v√† c√†i c√°c g√≥i b·ªï tr·ª£ cho OS.

  ```sh
  apt-get update -y && apt-get upgrade -y
  apt-get -y install -y vim curl wget 
  apt-get -y install byobu
  ```
T·∫Øt t√≠nh nƒÉng swap c·ªßa OS.

- Do K8S kh√¥ng h·ªó tr·ª£ swap n√™n c·∫ßn ph·∫£i t·∫Øt swap n·∫øu nh∆∞ trong l√∫c c√†i OS b·∫°n ƒë√£ c·∫•u h√¨nh, c√°c b∆∞·ªõc nh∆∞ sau.
Th·ª±c hi·ªán l·ªánh

	```sh
	swapoff -a
	````

- M·ªü file `/etc/fstab` v√† comment d√≤ng swap l·∫°i nh∆∞ ·∫£nh: http://prntscr.com/jd638u 
- Ki·ªÉm tra l·∫°i b·∫±ng l·ªánh `free -m` n·∫øu d√≤ng swap b√°o gi√° tr·ªã 0 l√† ƒë√£ t·∫Øt swap th√†nh c√¥ng, tham kh·∫£o: http://prntscr.com/jd63wk


- ƒê·∫∑t ip cho node `k8s-master` b·∫±ng c√°ch ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ s·ª≠a file file `/etc/network/interfaces`

  ```sh
  cat << EOF > /etc/network/interfaces
  # This file describes the network interfaces available on your system
  # and how to activate them. For more information, see interfaces(5).

  source /etc/network/interfaces.d/*

  # The loopback network interface
  auto lo
  iface lo inet loopback

  # The primary network interface
  auto ens4
  iface ens4 inet static
  address 172.16.68.130
  netmask 255.255.255.0
  gateway 172.16.68.1
  dns-nameservers 8.8.8.8
  EOF

- ƒê·∫∑t hostname cho m√°y `k8s-master` b·∫±ng c√°ch s·ª≠a n·ªôi dung c√°c file `/etc/hosts` v√† `/etc/hostname`
  - Ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ khai b√°o hostname cho `k8s-node1`
    ```sh
    cat << EOF > /etc/hosts
    127.0.0.1       localhost k8s-master
    172.16.68.130       k8s-master
    172.16.68.131       k8s-k8s-node1
    172.16.68.132       k8s-node2
    EOF
    ```
    
  - File `/etc/hostname` ƒë∆∞·ª£c s·ª≠a b·∫±ng l·ªánh d∆∞·ªõi.
    ```sh
    echo k8s-master > /etc/hostname
    ```
    
- Kh·ªüi ƒë·ªông l·∫°i node k8s-master
  ```sh
  init 6
  ```

#### 3.1. ƒê·∫∑t hostname v√† ip cho node `k8s-node1`
- Th·ª±c hi·ªán update v√† c√†i c√°c g√≥i b·ªï tr·ª£ cho OS.

  ```sh
  apt-get update -y && apt-get upgrade -y
  apt-get -y install -y vim curl wget 
  apt-get -y install byobu
  ```
T·∫Øt t√≠nh nƒÉng swap c·ªßa OS.

- Do K8S kh√¥ng h·ªó tr·ª£ swap n√™n c·∫ßn ph·∫£i t·∫Øt swap n·∫øu nh∆∞ trong l√∫c c√†i OS b·∫°n ƒë√£ c·∫•u h√¨nh, c√°c b∆∞·ªõc nh∆∞ sau.
Th·ª±c hi·ªán l·ªánh

	```sh
	swapoff -a
	````

- M·ªü file `/etc/fstab` v√† comment d√≤ng swap l·∫°i nh∆∞ ·∫£nh: http://prntscr.com/jd638u 
- Ki·ªÉm tra l·∫°i b·∫±ng l·ªánh `free -m` n·∫øu d√≤ng swap b√°o gi√° tr·ªã 0 l√† ƒë√£ t·∫Øt swap th√†nh c√¥ng, tham kh·∫£o: http://prntscr.com/jd63wk
- ƒê·∫∑t ip cho node `k8s-node1` b·∫±ng c√°ch ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ s·ª≠a file file `/etc/network/interfaces`

  ```sh
  cat << EOF > /etc/network/interfaces
  # This file describes the network interfaces available on your system
  # and how to activate them. For more information, see interfaces(5).

  source /etc/network/interfaces.d/*

  # The loopback network interface
  auto lo
  iface lo inet loopback

  # The primary network interface
  auto ens4
  iface ens4 inet static
  address 172.16.68.131
  netmask 255.255.255.0
  gateway 172.16.68.1
  dns-nameservers 8.8.8.8
  EOF
  ```

- ƒê·∫∑t hostname cho m√°y `k8s-master` b·∫±ng c√°ch s·ª≠a n·ªôi dung c√°c file `/etc/hosts` v√† `/etc/hostname`
  - Ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ khai b√°o hostname cho `k8s-node1`
    ```sh
    cat << EOF > /etc/hosts
    127.0.0.1       localhost k8s-node1
    172.16.68.130       k8s-master
    172.16.68.131       k8s-node1
    172.16.68.132       k8s-node2
    EOF
    ```
    
    ```sh
    echo k8s-node1 > /etc/hostname
    ```
    
- Kh·ªüi ƒë·ªông l·∫°i `k8s-node1`
  ```sh
  init 6
  ```

#### 3.2. ƒê·∫∑t hostname v√† ip cho node `k8s-node2`
- Th·ª±c hi·ªán update v√† c√†i c√°c g√≥i b·ªï tr·ª£ cho OS.

  ```sh
  apt-get update -y && apt-get upgrade -y
  apt-get -y install -y vim curl wget 
  apt-get -y install byobu
  ```
T·∫Øt t√≠nh nƒÉng swap c·ªßa OS.

- Do K8S kh√¥ng h·ªó tr·ª£ swap n√™n c·∫ßn ph·∫£i t·∫Øt swap n·∫øu nh∆∞ trong l√∫c c√†i OS b·∫°n ƒë√£ c·∫•u h√¨nh, c√°c b∆∞·ªõc nh∆∞ sau.
Th·ª±c hi·ªán l·ªánh

	```sh
	swapoff -a
	````

- M·ªü file `/etc/fstab` v√† comment d√≤ng swap l·∫°i nh∆∞ ·∫£nh: http://prntscr.com/jd638u 
- Ki·ªÉm tra l·∫°i b·∫±ng l·ªánh `free -m` n·∫øu d√≤ng swap b√°o gi√° tr·ªã 0 l√† ƒë√£ t·∫Øt swap th√†nh c√¥ng, tham kh·∫£o: http://prntscr.com/jd63wk
- ƒê·∫∑t ip cho node `k8s-node2` b·∫±ng c√°ch ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ s·ª≠a file file `/etc/network/interfaces`

  ```sh
  cat << EOF > /etc/network/interfaces
  # This file describes the network interfaces available on your system
  # and how to activate them. For more information, see interfaces(5).

  source /etc/network/interfaces.d/*

  # The loopback network interface
  auto lo
  iface lo inet loopback

  # The primary network interface
  auto ens4
  iface ens4 inet static
  address 172.16.68.132
  netmask 255.255.255.0
  gateway 172.16.68.1
  dns-nameservers 8.8.8.8
  EOF
  ```

- ƒê·∫∑t hostname cho m√°y `k8s-master` b·∫±ng c√°ch s·ª≠a n·ªôi dung c√°c file `/etc/hosts` v√† `/etc/hostname`
  - Ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ khai b√°o hostname cho `k8s-node2`
    ```sh
    cat << EOF > /etc/hosts
    127.0.0.1       localhost k8s-node2
    172.16.68.130       k8s-master
    172.16.68.131       k8s-node1
    172.16.68.132       k8s-node2
    EOF
    ```
    
  - File `/etc/hostname` ƒë∆∞·ª£c s·ª≠a b·∫±ng l·ªánh d∆∞·ªõi.
    ```sh
    echo k8s-node2 > /etc/hostname
    ```
    
- Kh·ªüi ƒë·ªông l·∫°i `k8s-node2`
  ```sh
  init 6
  ```

### 4. C√†i ƒë·∫∑t docker v√† c√°c th√†nh ph·∫ßn c·∫ßn thi·∫øt c·ªßa K8S.
Tr√™n t·∫•t c·∫£ c√°c node s·∫Ω c√†i c√°c th√†nh ph·∫ßn: `docker, kubelet, kubeadm v√† kubectl`. Trong ƒë√≥:
- `docker`: ƒë·ªÉ l√†m m√¥i tr∆∞·ªùng ch·∫°y c√°c container.
- `kubeadm`: ƒê∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ thi·∫øt l·∫≠p c·ª•m cluster cho K8S. (Cluster l√† m·ªôt c·ª•m m√°y th·ª±c hi·ªán chung m·ªôt m·ª•c ƒë√≠ch). C√°c t√†i li·ªáu chuy√™n m√¥n g·ªçi `kubeadm` l√† b·ªôt bootstrap (bootstrap t·∫°m hi·ªÉu m·ªôt tools ƒë√≥ng g√≥i ƒë·ªÉ t·ª± ƒë·ªông l√†m vi·ªác g√¨ ƒë√≥)
- `kubelet`: L√† th√†nh ph·∫ßn ch·∫°y tr√™n c√°c host, c√≥ nhi·ªám v·ª• k√≠ch ho·∫°t c√°c pod v√† container trong c·ª•m Cluser c·ªßa K8S.
- `kubectl`: L√† c√¥ng c·ª• cung c·∫•p CLI (Giao di·ªán d√≤ng l·ªánh) ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi K8S.

#### 4.1. C√†i ƒë·∫∑t docker tr√™n t·∫•t c·∫£ c√°c node 

```sh
apt-get -y update && apt-get -y install docker.io
```

#### 4.2. C√†i ƒë·∫∑t c√°c th√†nh ph·∫ßn c·ªßa K8S tr√™n t·∫•t c·∫£ c√°c node.

- C√†i ƒë·∫∑t tr√™n t·∫•t c·∫£ c√°c node  

```sh
apt-get update && apt-get install -y apt-transport-https

curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add 

cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF

apt-get update  -y
apt-get install -y kubelet kubeadm kubectl
```


#### 4.3 Thi·∫øt l·∫≠p cluster 

- ƒê·ª©ng tr√™n node `k8s-master` th·ª±c hi·ªán l·ªánh d∆∞·ªõi ƒë·ªÉ thi·∫øt l·∫≠p cluster

  ```sh
  kubeadm init --apiserver-advertise-address 172.16.68.130 --pod-network-cidr=10.244.0.0/16
  ```
  
- Trong ƒë√≥:
  - `172.16.68.130`: l√† IP c·ªßa node k8s-master.
  - `--apiserver-advertise-address`: l√† ƒë·ªãa ch·ªâ c·ªßa node k8s-master, ƒë·ªãa ch·ªâ n√†y c·∫ßn truy·ªÅn th√¥ng ƒë∆∞·ª£c v·ªõi c√°c node c√≤n l·∫°i trong c·ª•m cluster. Trong v√≠ d·ª• n√†y node k8s-master c√≥ ƒë·ªãa ch·ªâ l√†: 172.16.68.130.
	- `--pod-network-cidr`: l√† d·∫£i ƒë·ªãa ch·ªâ m·∫°ng ph·ª• thu·ªôc m√† c√¥ng ngh·ªá network s·∫Ω s·ª≠ d·ª•ng khi k·∫øt h·ª£p v·ªõi K8S, trong h∆∞·ªõng d·∫´n n√†y ta s·ª≠ d·ª•ng flannet v√† flannet s·ª≠ d·ª•ng d·∫£i `10.244.0.0/16. `

- Sau khi ch·∫°y k·∫øt qu·∫£ nh∆∞ sau l√† th√†nh c√¥ng: http://paste.openstack.org/raw/720277/ (N·∫øu ch∆∞a ƒë√∫ng th√¨ ki·ªÉm tra l·∫°i t·ª´ ƒë·∫ßu nh√© üòâ) 
- L∆∞u √Ω quan tr·ªçng: Trong output ·ªü tr√™n c√≥ d√≤ng d∆∞·ªõi, s·ª≠ d·ª•ng d√≤ng n√†y ƒë·ªÉ join c√°c node k8s-node1 v√† k8s-node2 v√†o c·ª•m cluster ·ªü b∆∞·ªõc d∆∞·ªõi  (Kh√¥ng ch·∫°y l·ªánh n√†y ·ªü ƒë√¢y  - v√¨ ch·ªâ l√† note l∆∞u √Ω).
 
- Lu∆∞ √Ω: N·∫øu g·∫∑p th√¥ng b√°o l·ªói `[ERROR Swap]: running with swap on is not supported. Please disable swap`   khi th·ª±c hi·ªán `kubeadm init` th√¨ c·∫ßn th·ª±c hi·ªán l·ªánh `swapoff -a`. Sau ƒë√≥ th·ª±c hi·ªán l·∫°i l·ªánh ·ªü tr√™n.

- K·∫øt qu·∫£ c·ªßa l·ªánh tr√™n nh∆∞ b√™n d∆∞·ªõi ho·∫∑c nh∆∞ ·∫£nh http://prntscr.com/i5icxv

  ```sh
  root@k8s-master:~#   kubeadm init --apiserver-advertise-address 172.16.68.130 --pod-network-cidr=10.244.0.0/16
  [init] Using Kubernetes version: v1.9.2
  [init] Using Authorization modes: [Node RBAC]
  [preflight] Running pre-flight checks.
          [WARNING FileExisting-crictl]: crictl not found in system path
  [certificates] Generated ca certificate and key.
  [certificates] Generated apiserver certificate and key.
  [certificates] apiserver serving cert is signed for DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 172.16.68.130]
  [certificates] Generated apiserver-kubelet-client certificate and key.
  [certificates] Generated sa key and public key.
  [certificates] Generated front-proxy-ca certificate and key.
  [certificates] Generated front-proxy-client certificate and key.
  [certificates] Valid certificates and keys now exist in "/etc/kubernetes/pki"
  [kubeconfig] Wrote KubeConfig file to disk: "admin.conf"
  [kubeconfig] Wrote KubeConfig file to disk: "kubelet.conf"
  [kubeconfig] Wrote KubeConfig file to disk: "controller-manager.conf"
  [kubeconfig] Wrote KubeConfig file to disk: "scheduler.conf"
  [controlplane] Wrote Static Pod manifest for component kube-apiserver to "/etc/kubernetes/manifests/kube-apiserver.yaml"
  [controlplane] Wrote Static Pod manifest for component kube-controller-manager to "/etc/kubernetes/manifests/kube-controller-manager.yaml"
  [controlplane] Wrote Static Pod manifest for component kube-scheduler to "/etc/kubernetes/manifests/kube-scheduler.yaml"
  [etcd] Wrote Static Pod manifest for a local etcd instance to "/etc/kubernetes/manifests/etcd.yaml"
  [init] Waiting for the kubelet to boot up the control plane as Static Pods from directory "/etc/kubernetes/manifests".
  [init] This might take a minute or longer if the control plane images have to be pulled.
  [apiclient] All control plane components are healthy after 56.503430 seconds
  [uploadconfig]¬†Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
  [markk8s-master] Will mark node k8s-master as k8s-master by adding a label and a taint
  [markk8s-master] k8s-master k8s-master tainted and labelled with key/value: node-role.kubernetes.io/k8s-master=""
  [bootstraptoken] Using token: 1aeb1d.89a15bf6272c8274
  [bootstraptoken] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
  [bootstraptoken] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
  [bootstraptoken] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
  [bootstraptoken] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
  [addons] Applied essential addon: kube-dns
  [addons] Applied essential addon: kube-proxy

  Your Kubernetes k8s-master has initialized successfully!

  To start using your cluster, you need to run the following as a regular user:

    mkdir -p $HOME/.kube
    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    sudo chown $(id -u):$(id -g) $HOME/.kube/config

  You should now deploy a pod network to the cluster.
  Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
    https://kubernetes.io/docs/concepts/cluster-administration/addons/

  You can now join any number of machines by running the following on each node
  as root:

    kubeadm join --token 1aeb1d.89a15bf6272c8274 172.16.68.130:6443 --discovery-token-ca-cert-hash sha256:cb8e0cd1238dc8fe8b1b2f16fe02817425005f04a8ddd09a7c19db08b75f72eb

  root@k8s-master:~#
  ```

- Quan s√°t c·ªßa s·ªï ssh v√† th·ª±c hi·ªán theo th√¥ng b√°o, th·ª±c hi·ªán ti·∫øp tr√™n node `k8s-master` ƒë·ªÉ c·∫•u h√¨nh `kubectl` cho node k8s-master.

- T·ªõi b∆∞·ªõc n√†y ta c√≥ 02 l·ª±a ch·ªçn ƒë·ªÉ thao t√°c v·ªõi K8S, l·ª±a ch·ªçn 1 l√† s·ª≠ d·ª•ng t√†i kho·∫£n `root`, l·ª±a ch·ªçn 2 l√† s·ª≠ d·ª•ng m·ªôt t√†i kho·∫£n kh√°c, h∆∞·ªõng d·∫´n n√†y l√† t√†i kho·∫£n `ubuntu`.

#### L·ª±a chon 1: S·ª≠ d·ª•ng t√†i kho·∫£n `root` ƒë·ªÉ thao t√°c v·ªõi `K8S`. Trong l·ª±a ch·ªçn n√†y c√≥ 2 c√°ch:
- `C√°ch 1:` Trong m·ªói phi√™n ssh b·∫±ng t√†i kho·∫£n `root`, ƒë·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c l·ªánh c·ªßa K8S th√¨ c·∫ßn th·ª±c hi·ªán l·ªánh d∆∞·ªõi ƒë·ªÉ khai b√°o c√°c bi·∫øn m√¥i tr∆∞·ªùng

  ```sh
  export KUBECONFIG=/etc/kubernetes/admin.conf
  ```
    - B·∫Øt ƒë·∫ßu t·ª´ ƒë√¢y c√≥ th·ªÉ thao th√°c v·ªõi K8S b·∫±ng l·ªánh `kubectl` ƒë·ªÉ qu·∫£n tr·ªã. 

- `C√°ch 2:` Ho·∫∑c khai b√°o c·ªë ƒë·ªãnh bi·∫øn m√¥i tr∆∞·ªùng b·∫±ng c√°c l·ªánh d∆∞·ªõi ƒë√¢y. L√∫c n√†y ta kh√¥ng c·∫ßn th·ª±c hi·ªán export nh∆∞ ·ªü tr√™n n·ªØa.

	```
	mkdir -p $HOME/.kube
	sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
	sudo chown $(id -u):$(id -g) $HOME/.kube/config
	```

T·ªõi ƒë√¢y s·∫Ω chuy·ªÉn xu·ªëng b∆∞·ªõc `C√†i ƒë·∫∑t Pod Network` n·∫øu nh∆∞ kh√¥ng mu·ªën c√≥ th√™m l·ª±a ch·ªçn 2.
	
#### L·ª±a chon 2: S·ª≠ d·ª•ng m·ªôt t√†i kho·∫£n kh√°c t√†i kho·∫£n `root`
- T·∫°o user `ubuntu` ƒë·ªÉ th·ª±c hi·ªán c·∫•u h√¨nh cho K8S. N·∫øu c√≥ user tr∆∞·ªõc ƒë√≥ r·ªìi th√¨ kh√¥ng c·∫ßn th·ª±c hi·ªán b∆∞·ªõc n√†y.

  ```sh
  adduser ubuntu
  ```

- Nh·∫≠p th√¥ng tin v√† m·∫≠t kh·∫©u cho user `ubuntu`, sau ƒë√≥ ph√¢n quy·ªÅn sudoer b·∫±ng l·ªánh d∆∞·ªõi.

  ```sh
  echo "ubuntu ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
  ```
  
- Chuy·ªÉn sang user ubuntu ƒë·ªÉ th·ª±c hi·ªán.

  ```sh
  su - ubuntu
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
  ```

- S·ª≠ d·ª•ng th·ªß thu·∫≠t d∆∞·ªõi ƒë·ªÉ thao t√°c l·ªánh trong k8s ƒë∆∞·ª£c thu·∫≠n l·ª£i h∆°n nh·ªù vi·ªác t∆∞ ƒë·ªông ho√†n thi·ªán l·ªánh m·ªói khi thao t√°c.

	```sh
	echo "source <(kubectl completion bash)" >> ~/.bashrc
	```

T·ªõi ƒë√¢y s·∫Ω chuy·ªÉn xu·ªëng b∆∞·ªõc `C√†i ƒë·∫∑t Pod Network` n·∫øu nh∆∞ kh√¥ng mu·ªën c√≥ th√™m l·ª±a ch·ªçn 2.

#### 4.4 C√†i ƒë·∫∑t Pod Network 

- ƒê·ª©ng tr√™n node k8s-master c√†i ƒë·∫∑t Pod network.
- K8S c√≥ nhi·ªÅu l·ª±a ch·ªçn cho gi·∫£i ph√°p network ƒë·ªÉ k·∫øt n·ªëi c√°c container, trong h∆∞·ªõng d·∫´n n√†y ch√∫ng t√¥i s·ª≠ d·ª•ng `flannel`

  ```sh
	kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
  ```

  - K·∫øt qu·∫£ c·ªßa l·ªánh tr√™n nh∆∞ sau:
	
	```sh
	root@k8s-master:~# kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
	clusterrole.rbac.authorization.k8s.io "flannel" created
	clusterrolebinding.rbac.authorization.k8s.io "flannel" created
	serviceaccount "flannel" created
	configmap "kube-flannel-cfg" created
	daemonset.extensions "kube-flannel-ds" created
	```

- T·ª´ b·∫£n 1.9 tr·ªü l√™n, th·ª±c hi·ªán l·ªánh d∆∞·ªõi ƒë·ªÉ t·∫°o token tr√™n node k8s-master, k·∫øt qu·∫£ tr·∫£ v√™ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ th·ª±c hi·ªán tr√™n c√°c k8s-node1 v√† k8s-node2

  ```sh
   sudo kubeadm token create --print-join-command
  ```
	
  - K·∫øt qu·∫£ nh∆∞ b√™n d∆∞·ªõi, l∆∞u gi√° tr·ªã trong c·ªôt token ƒë·ªÉ s·ª≠ d·ª•ng cho vi·ªác join c√°c k8s-node1 v√† k8s-node2 v√†o c·ª•m cluster:
	
    ```sh
    kubeadm join --token 150984.0da1fe160e5113f0 172.16.68.130:6443 --discovery-token-ca-cert-hash sha256:cb8e0cd1238dc8fe8b1b2f16fe02817425005f04a8ddd09a7c19db08b75f72eb
    ```
- Sau ƒë√≥ d√πng k·∫øt qu·∫£ tr√™n ƒë·ªÉ copy v√† th·ª±c hi·ªán tr√™n c√°c k8s-node1 v√† k8s-node2.
    
#### 4.5. Th·ª±c hi·ªán join `k8s-node1` v√† `k8s-node2` v√†o cluster
- ƒê·ª©ng tr√™n c·∫£ `k8s-node1` v√† `k8s-node2` th·ª±c hi·ªán 

  ```sh
  kubeadm join --token 150984.0da1fe160e5113f0 172.16.68.130:6443 --discovery-token-ca-cert-hash sha256:cb8e0cd1238dc8fe8b1b2f16fe02817425005f04a8ddd09a7c19db08b75f72eb
  ````
  
- L∆∞u √Ω: N·∫øu c√≥ th√¥ng b√°o `[ERROR Swap]: running with swap on is not supported. Please disable swap` khi th·ª±c hi·ªán l·ªánh join th√¨ s·ª≠ d·ª•ng l·ªánh d∆∞·ªõi v√† th·ª±c hi·ªán l·∫°i l·ªánh join.

  ```sh
  swapoff -a
  ```
  
- K·∫øt qu·∫£ tr·∫£ v·ªÅ l√†:

  ```sh
  [preflight] Running pre-flight checks.
          [WARNING FileExisting-crictl]: crictl not found in system path
  [discovery] Trying to connect to API Server "172.16.68.130:6443"
  [discovery] Created cluster-info discovery client, requesting info from "https://172.16.68.130:6443"
  [discovery] Requesting info from "https://172.16.68.130:6443" again to validate TLS against the pinned public key
  [discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server "172.16.68.130:6443"
  [discovery] Successfully established connection with API Server "172.16.68.130:6443"

  This node has joined the cluster:
  * Certificate signing request was sent to k8s-master and a response
    was received.
  * The Kubelet was informed of the new secure connection details.

  Run 'kubectl get nodes' on the k8s-master to see this node join the cluster.
  root@k8s-node1:~#
  ```

- `L∆∞u √Ω`: l√† c·∫ßn th·ª±c hi·ªán tr√™n c·∫£ 02 node `k8s-node1` v√† `k8s-node2`

- Sau khi th·ª±c hi·ªán join c·∫£ 02 `k8s-node1` v√† `k8s-node2` th√¨ quay l·∫°i node `k8s-master` ƒë·ªÉ ki·ªÉm tra c√°c node xem ƒë√£ join ƒë∆∞·ª£c hay ch∆∞a.

  ```sh
  export KUBECONFIG=/etc/kubernetes/admin.conf
  kubectl get nodes
  ```

- K·∫øt qu·∫£ tr·∫£ v·ªÅ c·ªßa l·ªánh tr√™n nh∆∞ sau.

  ```sh
  NAME      STATUS    ROLES     AGE       VERSION
  k8s-master    Ready     k8s-master    9h        v1.9.2
  k8s-node1     Ready     <none>    8h        v1.9.2
  k8s-node2     Ready     <none>    6m        v1.9.2
  ```

- Ch√∫ng ta c√≥ th·ªÉ th·∫•y ·ªü c·ªôt `STATUS` ƒë√£ c√≥ tr·∫°ng th√°i `Ready`. Ti·∫øp t·ª•c th·ª±c hi·ªán hi·ªán l·ªánh d∆∞·ªõi ƒë·ªÉ download ho·∫∑c ki·ªÉm tra tr·∫°ng th√°i c·ªßa c√°c th√†nh ph·∫ßn trong K8S tr√™n c√°c node ƒë√£ ho·∫°t ƒë·ªông hay ch∆∞a.

  ```sh
  kubectl get pod --all-namespaces
  ```

- K·∫øt qu·∫£ nh∆∞ b√™n d∆∞·ªõi l√† ok (ki·ªÉm tra c·ªôt `STATUS`). 

  ```sh
  NAMESPACE     NAME                             READY     STATUS    RESTARTS   AGE
  kube-system   etcd-k8s-master                      1/1       Running   0          9h
  kube-system   kube-apiserver-k8s-master            1/1       Running   0          9h
  kube-system   kube-controller-manager-k8s-master   1/1       Running   0          9h
  kube-system   kube-dns-6f4fd4bdf-ctxx7         3/3       Running   0          9h
  kube-system   kube-flannel-ds-kjnhs            1/1       Running   0          9h
  kube-system   kube-flannel-ds-wz648            1/1       Running   0          8h
  kube-system   kube-flannel-ds-xtcj9            1/1       Running   0          36m
  kube-system   kube-proxy-5slwp                 1/1       Running   0          36m
  kube-system   kube-proxy-5trrj                 1/1       Running   0          9h
  kube-system   kube-proxy-b54bs                 1/1       Running   0          8h
  kube-system   kube-scheduler-k8s-master            1/1       Running   0          9h
  ```

- Trong m·ªôt v√†i tr∆∞·ªùng h·ª£p c·ªôt `STATUS` s·∫Ω c√≥ tr·∫°ng th√°i `Pending, ContainerCreating,ImagePullBackOf` ƒë·ªëi v·ªõi m·ªôt s·ªë th√†nh ph·∫ßn, c√≥ th·ªÉ ch·ªù ho·∫∑c ki·ªÉm tra b·∫±ng l·ªánh `kubectl describe pod <ten_pod> --namespace=kube-system` , ·ªü ƒë√¢y t√™n pod ƒë∆∞·ª£c l·∫•y t·ª´ c·ªôt `NAME`.

	```sh
	export KUBECONFIG=/etc/kubernetes/admin.conf
	
	kubectl describe pod kube-scheduler-k8s-master --namespace=kube-system
	```
	
	- K·∫øt qu·∫£: http://paste.openstack.org/raw/653532/
  
T·ªõi ƒë√¢y ch√∫ng ta ƒë√£ c√≥ m√¥i tr∆∞·ªùng ƒë·ªÉ b·∫Øt ƒë·∫ßu th·ª±c h√†nh v·ªõi K8S r·ªìi. Sau ph·∫ßn n√†y ch√∫ng ta n√™n ƒë·ªçc sang ph·∫ßn c√°c kh√°i ni·ªám trong K8S tr∆∞·ªõc khi ƒëi v√†o th·ª±c h√†nh chi ti·∫øt h∆°n.


### 5. Ch·∫°y th·ª≠ ·ª©ng d·ª•ng 
- Sau khi c√†i ƒë·∫∑t xong K8S v√† ki·ªÉm tra ho·∫°t ƒë·ªông c∆° b·∫£n th√¨ ng∆∞·ªùi d√πng th∆∞·ªùng t√≤ m√≤ v·ªÅ c√°ch t·∫°o v√† ch·∫°y th·ª≠ c√°c ·ª©ng d·ª•ng ho·∫∑c t√†i nguy√™n tr√™n c·ª•m cluster v·ª´a d·ª±ng, do v·∫≠y trong ph·∫ßn n√†y t√¥i s·∫Ω gi·ªõi thi·ªáu th√™m c√°c thao t√°c c∆° b·∫£n ƒë·ªÉ qu·∫£n l√Ω c√°c t√†i nguy√™n v√† t·∫°o ra c√°c ·ª©ng d·ª•ng ho√†n ch·ªânh ƒë·ªÉ gi·∫£i ƒë√°p s·ª± t√≤ m√≤ v√† gi√∫p ng∆∞·ªùi m·ªõi c√≥ th·ªÉ hi·ªÉu ƒë∆∞·ª£c c√°c b∆∞·ªõc c∆° b·∫£n sau qu√° tr√¨nh c√†i ƒë·∫∑t K8S.

- C√≥ 2 c√°ch ƒë·ªÉ t·∫°o ra c√°c t√†i nguy√™n ƒë·ªÉ ph·ª•c v·ª• c√°c ·ª©ng d·ª•ng tr√™n c·ª•m cluster K8S:
  - C√°ch 1: S·ª≠ d·ª•ng tr·ª±c ti·∫øp l·ªánh `kubectl`
  - C√°ch 2: S·ª≠ d·ª•ng file c·∫•u h√¨nh (file yml) v√† th·ª±c thi ch√∫ng b·∫±ng l·ªánh `kube apply`. C√≥ nghƒ©a l√† ta s·∫Ω so·∫°n c√°c file theo c√∫ ph√°p c·ªßa yml v√† th·ª±c hi·ªán l·ªánh `kubectl apply` ƒë·ªÉ th·ª±c thi c√°c t√°c v·ª•.
		
Trong ph·∫°m vi ph·∫ßn n√†y, s·∫Ω gi·ªõi thi·ªáu c√°ch 1, c√°ch 2 s·∫Ω ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p trong ph·∫ßn n√¢ng cao sau.

- Sau ƒë√¢y, ch√∫ng ta s·∫Ω h·ªçc c√°ch t·∫°o ra m·ªôt ·ª©ng d·ª•ng l√† web server tr√™n K8S, ch√∫ng ta s·∫Ω th·ª±c hi·ªán l·∫ßn l∆∞·ª£t qua c√°c b∆∞·ªõc v√† d·∫ßn ti·∫øp c·∫≠n v·ªõi c√°c kh√°i ni·ªám trong qu√° tr√¨nh th·ª±c hi·ªán. Trong qu√° tr√¨nh th·ª±c hi·ªán c√°c b∆∞·ªõc ƒë·ªÉ t·∫°o ra ·ª©ng d·ª•ng nh∆∞ ng∆∞·ªùi d√πng mong mu·ªën, ch√∫ng ta s·∫Ω th·ª±c hi·ªán th√™m c√°c l·ªánh ƒë·ªÉ quan s√°t v√† ki·ªÉm ch·ª©ng l·∫°i k·∫øt qu·∫£.

- Khi c√°c ·ª©ng d·ª•ng ƒë∆∞·ª£c t·∫°o xong, ta s·∫Ω th·ª≠ truy c·∫≠p t·ª´ c√°c m√¥i tr∆∞·ªùng nh∆∞ local (ch√≠nh c√°c m√°y trong c·ª•m cluster, t·ª´ b√™n ngo√†i t·ª´ m√°y t√≠nh kh√°c c√°c c·ª•m cluster - c√≥ th·ªÉ l√† laptop ho·∫∑c c√°c m√°y trong m·∫°ng LAN v·ªõi laptop c·ªßa ch√∫ng ta).

- Cu·ªëi c√πng, ta s·∫Ω th·ª±c hi·ªán x√≥a ho·∫∑c h·ªßy c√°c ·ª©ng d·ª•ng ƒë·ªÉ s·∫µn s√†ng cho ph·∫ßn ti·∫øp theo :). Gi·ªù th√¨ h√£y b·∫Øt ƒë·∫ßu cho n

#### T·∫°o ·ª©ng d·ª•ng web server v·ªõi image l√† nginx tr√™n K8S.

- L∆∞u √Ω: ph·∫ßn n√†y s·∫Ω s·ª≠ d·ª•ng c√°ch t·∫°o ·ª©ng d·ª•ng v√† t√†i nguy√™n tr·ª±c ti·∫øp t·ª´ d√≤ng l·ªánh.
- Nh∆∞ ƒë√£ n√≥i ·ªü b√™n tr√™n, ch√∫ng ta s·∫Ω t·∫°o ra m·ªôt ·ª©ng d·ª•ng v·ªõi vai tr√≤ l√† web server, sau ƒë√≥ s·∫Ω th·ª±c hi·ªán c√°c thao t√°c qu·∫£n tr·ªã c√°c container, truy c·∫≠p v√†o ·ª©ng d·ª•ng ƒë√≥ t·ª´ c√°c m√¥i tr∆∞·ªùng b√™n trong v√†o b√™n ngo√†i ƒë·ªÉ ki·ªÉm tra ho·∫°t ƒë·ªông.
- Th∆∞·ªùng th√¨ c√°c ·ª©ng d·ª•ng tr√™n K8S ph·∫£i tr·∫£i qua c√°c b∆∞·ªõc d∆∞·ªõi: 

###### B∆∞·ªõc 1: T·∫°o container 

- T·∫°o 02 container v·ªõi images l√† nginx, 2 container n√†y ch·∫°y d·ª± ph√≤ng cho nhau, port c·ªßa c√°c container l√† 80

	```
	kubectl run test-nginx --image=nginx --replicas=2 --port=80 
	```
	
	- K·∫øt qu·∫£ nh∆∞ sau:
	
		```sh
		root@k8s-master:~# kubectl run test-nginx --image=nginx --replicas=2 --port=80
		deployment.apps "test-nginx" created
		root@k8s-master:~#
		```
	T·ªõi ƒë√¢y, ta m·ªõi t·∫°o ra c√°c container v√† ch·ªâ c√≥ th·ªÉ truy c·∫≠p t·ª´ c√°c m√°y trong c·ª•m cluster, b·ªüi v√¨ c√°c container n√†y ch∆∞a ƒë∆∞·ª£c m·ªü c√°c port ƒë·ªÉ √°nh x·∫° v·ªõi c√°c IP c·ªßa c√°c m√°y tr·ªçng c·ª•m K8S.
	
- Ta c√≥ th·ªÉ ki·ªÉm tra l·∫°i c√°c container n·∫±m trong c√°c POD (kh√°i ni·ªám POD ƒë·ªçc l·∫°i ·ªü tr∆∞·ªõc ƒë√≥ ho·∫∑c chuy·ªÉn sang ph·∫ßn c√°c kh√°i ni·ªám ƒë·ªÉ ƒë·ªçc th√™m) b·∫±ng l·ªánh

	```sh
	kubectl get pods -o wide
	```

	- K·∫øt qu·∫£: 
		```
		root@k8s-master:~# kubectl get pods -o wide
		NAME                         READY     STATUS    RESTARTS   AGE       IP           NODE
		test-nginx-959dbd6b6-7tx8l   1/1       Running   0          1m        10.244.2.5   k8s-node2
		test-nginx-959dbd6b6-h7xgg   1/1       Running   0          1m        10.244.1.5   k8s-node1
		```
		
	- Trong k·∫øt qu·∫£ tr√™n, ta c√≥ th·ªÉ quan s√°t th·∫•y tr·∫°ng th√°i c√°c container  ·ªü c·ªôt `STATUS` v√† ·ªü  c·ªôt `NODE` - n·ªùi m√† c√°c container ƒë∆∞·ª£c ph√¢n ph·ªëi, s·ªë l∆∞·ª£ng l√† container s·∫Ω l√† 2 v√¨ ch√∫ng ta ƒë√£ c√≥ t√πy ch·ªçn `--replicas=2`, vi·ªác ph√¢n ph·ªë s·ªë l∆∞·ª£ng container n√†y m·ªôt ph·∫ßn l√† do th√†nh ph·∫ßn scheduler trong K8S th·ª±c hi·ªán. Ngo√†i ra, trong c√°c ph·∫ßn n√¢ng cao sau c·ªßa t√†i li·ªáu n√†y, ch√∫ng ta s·∫Ω th·ª±c h√†nh th√™m vi·ªác thay ƒë·ªïi s·ªë l∆∞·ª£ng replicas (t·∫°m hi·ªÉu l√† s·ªë l∆∞·ª£ng container) sau khi ƒë√£ t·∫°o ch√∫ng ho·∫∑c sau khi deploy c√°c ·ª©ng d·ª•ng (ƒëi·ªÉm kh√° hay ho c·ªßa container n√≥i chung v√† K8S n√≥i ri√™ng).
	
- Ngo√†i ra ta c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh ƒë·ªÉ  d∆∞·ªõi ƒë·ªÉ xem c√°c service n√†o ƒë√£ s·∫µn s√†ng ƒë·ªÉ deployment.

	```sh
	kubectl get deployment
	```
	- K·∫øt qu·∫£ nh∆∞ b√™n d∆∞·ªõi (h√£y quan s√°t c·ªôt `AVAILABLE`, gi√° tr·ªã n√†y s·∫Ω thay ƒë·ªïi khi ta th·ª±c hi·ªán qu√° tr√¨nh deployment c√°c service n√†y).
	
		```sh
		root@k8s-master:~# kubectl get deployment
		NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
		test-nginx   2         2         2            0           27m
		```	
	
###### B∆∞·ªõc 2: Th·ª±c hi·ªán deploy ·ª©ng d·ª•ng tr√™n 

- Ch√≠nh l√† b∆∞·ªõc ph∆°i c√°c port c·ªßa container ra.
- T·ªõi b∆∞·ªõc n√†y, ch√∫ng ta ch∆∞a th·ªÉ truy c·∫≠p v√†o c√°c container ƒë∆∞·ª£c, c·∫ßn th·ª±c hi·ªán th√™m b∆∞·ªõc deploy c√°c container v·ªõi c√°c t√πy ch·ªçn ph√π h·ª£p, c·ª• th·ªÉ nh∆∞ sau

	```sh
	kubectl expose deploy test-nginx --port 80 --target-port 80 --type NodePort
	```

	- K·∫øt qu·∫£ 

		```sh
		root@k8s-master:~# kubectl expose deploy test-nginx --port 80 --target-port 80 --type NodePort
		service "test-nginx" exposed
		```
		
	- Ngo√†i c√°c t√πy ch·ªçn `--port 80` v√† `--target-port 80` th√¨ ta l∆∞u √Ω t√πy ch·ªçn `--type NodePort`, ƒë√¢y l√† t√πy ch·ªçn ƒë·ªÉ √°nh x·∫° port c·ªßa m√°y c√†i K8S v√†o container v·ª´a t·∫°o, s·ª≠ d·ª•ng c√°c l·ªánh d∆∞·ªõi ƒë·ªÉ bi·∫øt ƒë∆∞·ª£c port m√† host √°nh x·∫° l√† bao nhi√™u ·ªü b√™n d∆∞·ªõi.
		
- Quan s√°t k·ªπ h∆°n ·ª©ng d·ª•ng web server v·ª´a t·∫°o ·ªü tr√™n b·∫±ng l·ªánh 

	```sh
	kubectl describe service test-nginx
	```
  
	- K·∫øt qu·∫£ nh∆∞ b√™n d∆∞·ªõi, h√£y l∆∞u √Ω k·∫øt qu·∫£ n√†y.
		```sh
		root@k8s-master:~# kubectl describe service test-nginx
		Name:                     test-nginx
		Namespace:                default
		Labels:                   run=test-nginx
		Annotations:              <none>
		Selector:                 run=test-nginx
		Type:                     NodePort
		IP:                       10.107.71.150
		Port:                     <unset>  80/TCP
		TargetPort:               80/TCP
		NodePort:                 <unset>  32136/TCP
		Endpoints:                10.244.1.5:80,10.244.2.5:80
		Session Affinity:         None
		External Traffic Policy:  Cluster
		Events:                   <none>
		root@k8s-master:~#
		```
		
	- Trong k·∫øt qu·∫£ n√†y, ch√∫ng ta c√≥ th·ªÉ th·∫•y c√°c tham s·ªë quan tr·ªçng v√† c·∫ßn l∆∞u √Ω nh∆∞ sau: 
	
	  - `IP: 10.107.71.150`: l√† ƒë·ªãa ch·ªâ ƒë∆∞·ª£c c·∫•p ph√°t cho ·ª©ng d·ª•ng `test-nginx` v·ª´a t·∫°o ·ªü tr√™n, ƒë·ªãa ch·ªâ n√†y c√≥ √Ω nghƒ©a local.
		
		- `Endpoints: 10.244.1.5:80,10.244.2.5:80`: ƒê√¢y l√† ƒë·ªãa ch·ªâ c·ªßa d·∫£i m·∫°ng n·ªôi t·∫°i v√† li√™n k·∫øt c√°c container khi ch√∫ng thu·ªôc m·ªôt POD. Ta c√≥ th·ªÉ ƒë·ª©ng tr√™n m·ªôt trong c√°c node c·ªßa c·ª•m cluster K8S v√† th·ª±c hi·ªán l·ªánh curl ƒë·ªÉ truy c·∫≠p web, v√≠ d·ª•: `curl 10.244.1.5` ho·∫∑c `curl 10.244.2.5`. K·∫øt qu·∫£ tr·∫£ v·ªÅ html c·ªßa web server.
		
		- `Port v√† TargetPort`: l√† c√°c port n·∫±m trong ch·ªâ ƒë·ªãnh ·ªü l·ªánh khi ta deploy ·ª©ng d·ª•ng.
		
		- `NodePort: <unset>  32136/TCP`: ƒê√¢y ch√≠nh l√† port m√† ta d√πng ƒë·ªÉ truy c·∫≠p v√†o web server ƒë∆∞·ª£c t·∫°o ·ªü tr√™n th√¥ng qua m·ªôt trong c√°c IP c·ªßa c√°c m√°y trong c·ª•m cluser. Ta s·∫Ω c√≥ c√°c ki·ªÉm ch·ª©ng d∆∞·ªõi.
		
		
- ƒê·ª©ng tr√™n node k8s-master th·ª±c hi·ªán curl v√†o m·ªôt trong c√°c IP sau: 

	```sh

	curl 10.107.71.150 

	ho·∫∑c 

	curl 10.244.1.5

	ho·∫∑c 

	curl 10.244.2.5
	```

	- K·∫øt qu·∫£:

		```sh
		root@k8s-master:~# curl  10.244.1.5
		<!DOCTYPE html>
		<html>
		<head>
		<title>Welcome to nginx!</title>
		<style>
				body {
						width: 35em;
						margin: 0 auto;
						font-family: Tahoma, Verdana, Arial, sans-serif;
				}
		</style>
		</head>
		<body>
		<h1>Welcome to nginx!</h1>
		<p>If you see this page, the nginx web server is successfully installed and
		working. Further configuration is required.</p>

		<p>For online documentation and support please refer to
		<a href="http://nginx.org/">nginx.org</a>.<br/>
		Commercial support is available at
		<a href="http://nginx.com/">nginx.com</a>.</p>

		<p><em>Thank you for using nginx.</em></p>
		</body>
		</html>
		```
			
- ƒê·ª©ng tr√™n node `k8s-master` v√† th·ª±c hi·ªán ki·ªÉm tra port ƒë∆∞·ª£c √°nh x·∫° v·ªõi container (trong k·∫øt qu·∫£ tr√™n l√† port `32136/TCP`)

	```sh
	ss -lan | grep 32136
	```
	
  - K·∫øt qu·∫£:	
	
	```
	root@k8s-master:~# ss -lan | grep 32136
	tcp    LISTEN     0      128      :::32136                :::*
	root@k8s-master:~#
	```
			
- ƒê·ª©ng tr√™n m√°y Laptop ho·∫∑c m√°y kh√°c c√πng d·∫£i m·∫°ng v·ªõi d·∫£i IP c·ªßa c√°c node trong c·ª• K8S, m·ªü tr√¨nh duy·ªát web v√† truy c·∫≠p v·ªõi ƒë·ªãa ch·ªâ: `http://172.16.68.130:32136` ho·∫∑c `http://172.16.68.131:32136` ho·∫∑c `http://172.16.68.132:32136`, ch√∫ng ta s·∫Ω th·∫•y k·∫øt qu·∫£ nh∆∞ ·∫£nh:  http://prntscr.com/jhiy1r ho·∫∑c http://prntscr.com/jhiy3x


- Ta c√≥ th·ªÉ th·ª±c hi·ªán l·∫°i l·ªánh `kubectl get deployment` ƒë√£ d√πng tr∆∞·ªõc khi th·ª±c hi·ªán deploy service, l√∫c n√†y k·∫øt qu·∫£ c·ªßa c·ªôt `AVAILABLE` s·∫Ω thay ƒë·ªïi (s·ªë 2).

	```sh
	root@k8s-master:~# kubectl get deployment
	NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
	test-nginx   2         2         2            2           27m
	```

- S·ª≠ d·ª•ng c√°c l·ªánh `kubectl get services` ƒë·ªÉ bi·∫øt ƒë∆∞·ª£c c√°c vices ƒë∆∞·ª£c deploy v·ªõi vi·ªác √°nh x·∫° port l√† bao nhi√™u (ƒë√¢y c√≥ th·ªÉ l√† c√°ch xem port ƒë∆∞·ª£c √°nh x·∫° v·ªõi c√°c node).

	```sh
	root@k8s-master:~# kubectl get services
	NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
	kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP        2d
	test-nginx   NodePort    10.107.71.150   <none>        80:32136/TCP   24m
	```
	
T·ªõi ƒë√¢y, c√≥ l·∫Ω ƒëa nh∆∞ k·ª≥ v·ªçng c·ªßa ng∆∞·ªùi d√πng ban ƒë·∫ßu r·ªìi :). M·ªôt s·ªë k·ªπ thu·∫≠t ch·ªânh port theo nhu c·∫ßu ho·∫∑c link gi·ªØa c√°c container ta c√≥ th·ªÉ ki·ªÉm tra sau v√† th·ª±c hi·ªán ·ªü m·ª•c n√¢ng cao. Tr∆∞·ªõc khi k·∫øt th√∫c ph·∫ßn n√†y ta s·∫Ω th·ª±c hi·ªán m·ªôt s·ªë l·ªánh ƒë·ªÉ x√≥a c√°c service v√† Pod (c√°c container thu·ªôc Pod) ƒë·ªÉ chu·∫©n b·ªã cho ph·∫ßn sau.

- Th·ª±c hi·ªán x√≥a c√°c service v·ª´a t·∫°o ·ªü tr√™n.

	```sh
	kubectl delete service test-nginx

	kubectl delete deployment test-nginx
	```


- Sau ƒë√≥ ki·ªÉm tra l·∫°i b·∫±ng c√°c l·ªánh ƒë√£ d√πng ·ªü b√™n tr√™n

	```sh
	kubectl get services
	kubectl get deployments
	```

T·ªõi ƒë√¢y, ta ƒë√£ k·∫øt th√∫c b∆∞·ªõc c∆° b·∫£n ƒë·ªÉ th·ª±c hi·ªán t·∫°o v√† qu·∫£n l√Ω m·ªôt ·ª©ng d·ª•ng c∆° b·∫£n tr√™n c·ª•m cluster K8S, t·ª´ sau n√†y c√≥ th·ªÉ chuy·ªÉn sang c√°c b∆∞·ªõc v√† t√†i li·ªáu ti·∫øp theo ƒë·ªÉ v·ªçc v·∫°ch th√™m r·ªìi nh√© :) 


#### V√≠ d·ª• t·∫°o c√°c ·ª©ng d·ª•ng v·ªõi file yaml

- Trong ph·∫ßn tr∆∞·ªõc ƒë√£ h∆∞·ªõng d·∫´n t·∫°o th·ª≠ m·ªôt ·ª©ng d·ª•ng b·∫±ng c√°ch l·ªánh c·ªßa K8S. V·ªõi c√°ch s·ª≠ d·ª•ng l·ªánh th√¨ ƒë∆∞·ª£c d√πng ch·ªß y·∫øu ƒë·ªÉ ki·ªÉm tra v√† th·ª≠ m·ªôt s·ªë th√†nh ph·∫ßn ho·∫∑c container c∆° b·∫£n. Nh∆∞ng trong th·ª±c t·∫ø tri·ªÉn khai c√°c ·ª©ng d·ª•ng th√¨ k·ªπ thu·∫≠t s·ª≠ d·ª•ng file template l·∫°i ph·ªï bi·∫øn h∆°n, l√∫c n√†y vi·ªác tri·ªÉn khai gi·ªëng nh∆∞ b·∫°n ƒëang th·ª±c hi·ªán code, t·∫°o ra m·ªôt l·∫ßn v√† d√πng nhi·ªÅu l·∫ßn.


- Sau ƒë√¢y s·∫Ω l·∫•y v√≠ d·ª• v·ªÅ c√°ch tri·ªÉn khai m·ªôt ·ª©ng d·ª•ng tr√™n K8S b·∫±ng c√°ch s·ª≠ d·ª•ng file yaml.
- Copy n·ªôi dung d∆∞·ªõi v√† l∆∞u l·∫°i th√†nh file v·ªõi ƒëu√¥i m·ªü r·ªông l√† `yaml` ho·∫∑c `yml`, v√≠ d·ª• t√™n l√† `apache-app.yaml`

```
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: apache2
spec:
  template:
    metadata:
      labels:
        name: apache2
    spec:
      containers:
      - name: apache2
        image: httpd
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: apache2
spec:
  selector:
    name: apache2
  ports:
    - port: 5555
      targetPort: 80
  type: NodePort
```

- [Ho·∫∑c t·∫£i file ·ªü ƒë√¢y](https://raw.githubusercontent.com/congto/ghichep-kubernetes/master/files/apache-app.yaml)

- Sau ƒë√≥ th·ª±c hi·ªán l·ªánh d∆∞·ªõi ƒë·ªÉ deploy ·ª©ng d·ª•ng

	```
	kubectl create -f apache-app.yaml
	```
	
	- K·∫øt qu·∫£:
	
	```
	root@k8s-master:~# kubectl create -f apache-app.yaml
	deployment.apps "apache-app" created
	service "apache-app" created
	```
	
- Ki·ªÉm tra th√™m b·∫±ng c√°c l·ªánh

	```sh
	kubectl get services
	kubectl get deployments
	```

	- S·ª≠ d·ª•ng port ·ªü k·∫øt qu·∫£ ƒë·ªÉ truy c·∫≠p, v·ªõi node port s·∫Ω l√† `http://172.16.68.130:32316/` ho·∫∑c `http://172.16.68.131:32316/` ho·∫∑c `http://172.16.68.132:32316/`

	
Nh∆∞ v·∫≠y ta ƒë√£ ho√†n t·∫•t b∆∞·ªõc s·ª≠ d·ª•ng file ƒë·ªÉ tri·ªÉn khai c√°c container,  vi·ªác t√¨m hi·ªÉu c·∫•u tr√∫c file s·∫Ω ƒë∆∞·ª£c m√¥ t·∫£ ·ªü c√°c ph·∫ßn n√¢ng cao sau ;)

H·∫æT


### 6. C√†i ƒë·∫∑t Dashboard

H·∫≥n nhi·ªÅu b·∫°n sau khi c√†i ƒë·∫∑t xong k8s, c≈©ng t√≤ m√≤ h·ªèi xem n√≥ c√≥ giao di·ªán ƒë·ªì h·ªça (website) kh√¥ng. C√¢u tr·∫£ l·ªùi l√† c√≥. V√† ph·∫ßn n√†y s·∫Ω h∆∞·ªõng 
d·∫´n cho c√°c b·∫°n c√°ch thi·∫øt l·∫≠p giao di·ªán cho k8s

#### 6.1 C√†i ƒë·∫∑t

Sau khi c√†i ƒë·∫∑t k8s theo h∆∞·ªõng d·∫´n b√™n tr√™n, s·∫Ω ch∆∞a c√≥ giao di·ªán ngay cho b·∫°n s·ª≠ d·ª•ng. B·∫°n ch·∫°y l·ªánh sau ƒë·ªÉ c√†i ƒë·∫∑t th√™m container cung c·∫•p giao di·ªán.
```sh
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml
```

Ch·∫°y xong l·ªánh tr√™n, k·∫øt qu·∫£ c·ªßa l·ªánh nh∆∞ sau:
```sh
secret "kubernetes-dashboard-certs" created
serviceaccount "kubernetes-dashboard" created
role.rbac.authorization.k8s.io "kubernetes-dashboard-minimal" created
rolebinding.rbac.authorization.k8s.io "kubernetes-dashboard-minimal" created
deployment.apps "kubernetes-dashboard" configured
service "kubernetes-dashboard" created
```

container n√†y s·∫Ω ch·∫°y trong namespace c·ªßa k8s l√† `kube-system`.

#### 6.2 C·∫•u h√¨nh

B·∫°n ch·∫°y l·ªánh sau ƒë·ªÉ b·∫Øt ƒë·∫ßu v√†o giao di·ªán website:
```sh
kubectl proxy
```

B√¢y gi·ªù, c√≥ th·ªÉ ƒë·ª©ng tr√™n Master Node v√† truy c·∫≠p v√†o ƒë·ªãa ch·ªâ `http://localhost:8001` ho·∫∑c `http://127.0.0.1:8001` ƒë·ªÉ v√†o.

URL sau ƒë·ªÉ v√†o dashboard: `http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/`

Nh∆∞ng n·∫øu ƒë∆°n gi·∫£n v·∫≠y th√¨ c√≥ l·∫Ω kh√¥ng c·∫ßn t√¥i ph·∫£i vi·∫øt h∆∞·ªõng d·∫´n n√†y. C√°i c√πi b·∫Øp c·ªßa c√°ch truy c·∫≠p tr√™n l√† b·∫°n ph·∫£i s·ª≠ d·ª•ng m·ªôt tr√¨nh duy·ªát 
c√†i ƒë·∫∑t tr√™n ch√≠nh m√°y ch·ªß Master node ƒë·ªÉ truy c·∫≠p. L√†m c√°ch n√†o ƒë·ªÉ truy c·∫≠p t·ª´ n∆°i kh√°c th√¥ng qua IP c·ªßa Master node. Xin l√†m theo c√°c b∆∞·ªõc b√™n d∆∞·ªõi

ƒê·∫ßu ti√™n, b·∫°n ph·∫£i ch·ªânh s·ª≠a l·∫°i m·ªôt ch√∫t trong c·∫•u h√¨nh c·ªßa service `kubernetes-dashboard`. Ch·∫°y l·ªánh sau ƒë·ªÉ m·ªü
```sh
kubectl -n kube-system edit service kubernetes-dashboard
```

C√≥ m·ªôt giao di·ªán ch·ªânh s·ª≠a file ƒë∆∞·ª£c m·ªü ra (ch·∫Øc x√†i `vim`). B·∫°n t√¨m t·ªõi d√≤ng `type: ClusterIP` v√† ƒë·ªïi n√≥ th√†nh `type: NodePort`. Sau ƒë√≥ nh·∫•n ph√≠m 
`ESC` v√† `:x` ƒë·ªÉ l∆∞u l·∫°i.

L√∫c n√†y, service `kubernetes-dashboard` ƒë√£ l·∫•y m·ªôt port tr√™n Master Node ƒë·ªÉ NAT v√†o port `443` c·ªßa service. Ki·ªÉm tra
```sh
kubectl -n kube-system get service kubernetes-dashboard
```

K·∫øt qu·∫£:
```sh
NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE
kubernetes-dashboard   NodePort   10.108.100.24   <none>        443:30826/TCP   19m
```

T·ª´ tr√¨nh duy·ªát tr√™n m√°y c√° nh√¢n, b·∫°n v√†o ƒë∆∞·ªùng d·∫´n sau `https://192.168.30.37:30826`. Nh·ªõ l√† ph·∫£i x√†i `HTTPS` v√† thay IP, port t∆∞∆°ng ·ª©ng c·ªßa 
Master node.

T·ªõi ƒë√¢y, b·∫°n th√™m exception ssl cho tr√¨nh duy·ªát. S·∫Ω hi·ªÉn th·ªã m·ªôt m√†n h√¨nh ƒëƒÉng nh·∫≠p c√≥ 02 t√πy ch·ªçn `Kubeconfig` v√† `Token`. 

Th√¥ng th∆∞·ªùng, s·∫Ω x√†i token ƒë·ªÉ login. V·∫≠y `token` l·∫•y ·ªü ƒë√¢u. B·∫°n l√†m nh∆∞ sau.

Ch·∫°y l·ªánh li·ªát k√™ to√†n b·ªô `secret` ƒëang c√≥ tr√™n Master node
```sh
kubectl -n kube-system get secret
```

K·∫øt qu·∫£ c·ªßa l·ªánh tr√™n nh∆∞ sau:
```sh
NAME                                             TYPE                                  DATA      AGE
attachdetach-controller-token-2qzmx              kubernetes.io/service-account-token   3         8d
bootstrap-signer-token-4xf4c                     kubernetes.io/service-account-token   3         8d
bootstrap-token-mp1gba                           bootstrap.kubernetes.io/token         6         17h
certificate-controller-token-hp4pb               kubernetes.io/service-account-token   3         8d
clusterrole-aggregation-controller-token-82525   kubernetes.io/service-account-token   3         8d
cronjob-controller-token-h4r4q                   kubernetes.io/service-account-token   3         8d
daemon-set-controller-token-7jnmg                kubernetes.io/service-account-token   3         8d
default-token-vbq5r                              kubernetes.io/service-account-token   3         8d
deployment-controller-token-hw9z6                kubernetes.io/service-account-token   3         8d
disruption-controller-token-w88np                kubernetes.io/service-account-token   3         8d
endpoint-controller-token-c7kd7                  kubernetes.io/service-account-token   3         8d
flannel-token-znjq2                              kubernetes.io/service-account-token   3         8d
generic-garbage-collector-token-jcswb            kubernetes.io/service-account-token   3         8d
heapster-token-7sk58                             kubernetes.io/service-account-token   3         18h
horizontal-pod-autoscaler-token-2gwqd            kubernetes.io/service-account-token   3         8d
job-controller-token-h58gr                       kubernetes.io/service-account-token   3         8d
kube-dns-token-nlsm9                             kubernetes.io/service-account-token   3         8d
kube-proxy-token-zwsp7                           kubernetes.io/service-account-token   3         8d
kubernetes-dashboard-certs                       Opaque                                1         17h
kubernetes-dashboard-key-holder                  Opaque                                2         3d
kubernetes-dashboard-token-6vwnt                 kubernetes.io/service-account-token   3         19h
metrics-server-token-zntp6                       kubernetes.io/service-account-token   3         18h
namespace-controller-token-h9t47                 kubernetes.io/service-account-token   3         8d
node-controller-token-qlct6                      kubernetes.io/service-account-token   3         8d
persistent-volume-binder-token-69h9d             kubernetes.io/service-account-token   3         8d
pod-garbage-collector-token-j9d9f                kubernetes.io/service-account-token   3         8d
pv-protection-controller-token-m8zvk             kubernetes.io/service-account-token   3         8d
pvc-protection-controller-token-2xm8w            kubernetes.io/service-account-token   3         8d
replicaset-controller-token-h92xk                kubernetes.io/service-account-token   3         5m
replication-controller-token-dtf66               kubernetes.io/service-account-token   3         8d
resourcequota-controller-token-nkc65             kubernetes.io/service-account-token   3         8d
service-account-controller-token-dtg8c           kubernetes.io/service-account-token   3         8d
service-controller-token-mq55l                   kubernetes.io/service-account-token   3         8d
statefulset-controller-token-54fwx               kubernetes.io/service-account-token   3         8d
token-cleaner-token-grlqf                        kubernetes.io/service-account-token   3         8d
ttl-controller-token-59tgf                       kubernetes.io/service-account-token   3         8d
```

M·ªói `secret` s·∫Ω ch·ª©a m·ªôt `token` v·ªõi quy·ªÅn h·∫°n kh√°c nhau, b·∫°n ch·∫°y l·ªánh sau ƒë·ªÉ xem ƒë∆∞·ª£c `token` ƒëang ch·ª©a trong `secret` t∆∞∆°ng ·ª©ng. T√¥i l·∫•y m·ªôt `secret` b·∫•t k·ª≥
```sh
kubectl describe secret cluster-admin-dashboard-sa-token-r4x48
```

K·∫øt qu·∫£
```sh
Name:         cluster-admin-dashboard-sa-token-r4x48
Namespace:    default
Labels:       <none>
Annotations:  kubernetes.io/service-account.name=cluster-admin-dashboard-sa
              kubernetes.io/service-account.uid=b0264e18-5c9a-11e8-874a-525400fd9cfb

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1025 bytes
namespace:  7 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImNsdXN0ZXItYWRtaW4tZGFzaGJvYXJkLXNhLXRva2VuLXI0eDQ4Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImNsdXN0ZXItYWRtaW4tZGFzaGJvYXJkLXNhIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYjAyNjRlMTgtNWM5YS0xMWU4LTg3NGEtNTI1NDAwZmQ5Y2ZiIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6Y2x1c3Rlci1hZG1pbi1kYXNoYm9hcmQtc2EifQ.mHpm3XZd5NWA8KAp3gmj3Zi5TnNlwnw7JwG-aqE9mMtleBr-a4aBzbIE2KR-1TaNR7daNqZ0SOb7lv8577PVAdM-pwBwFCHc1rJW6kzaNLywnuuSzmlkRG_3VgNA2j4hifaK0kSqClp3m6XW9YQdGXi89-ClNZl1YtUsFfInniUCBlR3Fj5uxsrIXZl8BivCT0jGDLvNgUGRC5Uau334phRYQsFpnSdg1iRbUaG9QO6IvOPTtn-dFPmMyJcNiDcN4_wMBii_LaVKTdLnRmTLw_gZyThkyCKh9216GAUTK-hgoGmE98L_GdA8gaQCO0urriNYkXUNK803t2_Y_eBnZg
```

B·∫°n copy l·∫•y ƒëo·∫°n `token` b·∫Øt ƒë·∫ßu t·ª´ ch·ªØ `ey...`, sau ƒë√≥ tr√™n giao di·ªán, b·∫°n ch·ªçn v√†o `Token`, paste ƒëo·∫°n `token` v·ª´a xong v√†o v√† `SIGN IN`

![k8s-dashboard](../../images/k8s-dashboard.png)

Ch√∫c m·ª´ng b·∫°n ƒë√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng. L∆∞u √Ω l√† m·ªói `token` c·ªßa `secret` l√† c√≥ quy·ªÅn kh√°c nhau nh√©.

Ngo√†i ra, b·∫°n c√≤n c√≥ th·ªÉ t·∫°o ri√™ng `secret` v·ªõi c√°c quy·ªÅn h·∫°n ri√™ng. ƒê√¢y l√† ph·∫ßn ph√¢n quy·ªÅn cho ng∆∞·ªùi d√πng. Tham kh·∫£o c√°ch t·∫°o ·ªü  [link](https://docs.giantswarm.io/guides/install-kubernetes-dashboard/)


### Tham kh·∫£o

- [https://github.com/kubernetes/dashboard](https://github.com/kubernetes/dashboard)
- [https://github.com/kubernetes/dashboard/wiki/Accessing-Dashboard---1.7.X-and-above](https://github.com/kubernetes/dashboard/wiki/Accessing-Dashboard---1.7.X-and-above)
- [https://docs.giantswarm.io/guides/install-kubernetes-dashboard/](https://docs.giantswarm.io/guides/install-kubernetes-dashboard/)
>>>>>>> refs/remotes/hocchudong/master
