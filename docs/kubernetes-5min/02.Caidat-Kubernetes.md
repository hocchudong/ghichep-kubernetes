## C√†i ƒëƒÉt Kubernetes 

### 1. M√¥i tr∆∞·ªùng
- Ubuntu 16.04 - 64 bit (3 node: 01 Node k8s-master, 02 node k8s-node1 & k8s-node2)
- Docker version Docker version 1.13.1, build 092cba3
- Kubernetes version v1.9.2

`L∆∞u √Ω`: T√†i li·ªáu th·ª±c h√†nh n√†y c√≥ √Ω nghƒ©a nh·∫•t v·ªõi c√°c phi√™n b·∫£n ƒë∆∞·ª£c k·ªÉ t√™n ·ªü tr√™n, c√°c phi√™n b·∫£n kh√°c ho·∫∑c c≈© h∆°n c·ªßa t·ª´ng th√†nh ph·∫ßn s·∫Ω c·∫ßn c√≥ h∆∞·ªõng d·∫´n kh√°c ho·∫∑c ch∆∞a ch·∫Øc ch·∫Øn c√°c b∆∞·ªõc th·ª±c hi·ªán nh∆∞ t√†i li·ªáu n√†y.


### 2. M√¥ h√¨nh & IP Planning

#### 2.1. M√¥ h√¨nh: 

![K8S-topology](../../images/K8S-topology.png)

- File topology online ƒë∆∞·ª£c cung c·∫•p ·ªü [link  n√†y](https://www.draw.io/#G1NmTeK-k590hew0GikQcl_TNiwO1nDjxK)

#### 2.2. IP Planning:

![ip-planning](../../images/ip-planning.png)

- L∆∞u √Ω: M·∫∑c d√π trong b·∫£ng tr√™n ta c√≥ 03 NICs cho m·ªói m√°y nh∆∞ng trong c√°c b∆∞·ªõc h∆∞·ªõng d·∫´n n√†y ta ch·ªâ c·∫ßn s·ª≠ d·ª•ng interface c√≥ d·∫£i `172.16.68.0/24`. C√°c d·∫£i c√≤n l·∫°i l√† do h·∫° t·∫ßng c·ªßa t√¥i v√† t√¥i chu·∫©n b·ªã s·∫µn ƒë·ªÉ cho c√°c m·ª•c ti√™u kh√°c. Do v·∫≠y ƒë·ªÉ l√†m theo LAB n√†y b·∫°n ch·ªâ m·ªói m√°y c√≥ 01 NIC l√† ƒë∆∞·ª£c. H√£y thay l·∫°i IP cho ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng c·ªßa b·∫°n nh√©.
 
### 3. B∆∞·ªõc chu·∫©n b·ªã

ƒê·∫∑t hostname, IP cho t·∫•t c·∫£ c√°c node theo IP Planning
- SSH v·ªõi t√†i kho·∫£n `root` v√† th·ª±c hi·ªán.

#### 3.1. ƒê·∫∑t hostname v√† ip cho node `k8s-master`
- Th·ª±c hi·ªán update v√† c√†i c√°c g√≥i b·ªï tr·ª£ cho OS.

  ```sh
  apt-get update -y && apt-get upgrade -y
  apt-get -y install -y vim curl wget 
  apt-get -y install byobu
  ```
T·∫Øt t√≠nh nƒÉng swap c·ªßa OS.

- Do K8S kh√¥ng h·ªó tr·ª£ swap n√™n c·∫ßn ph·∫£i t·∫Øt swap n·∫øu nh∆∞ trong l√∫c c√†i OS b·∫°n ƒë√£ c·∫•u h√¨nh, c√°c b∆∞·ªõc nh∆∞ sau.
Th·ª±c hi·ªán l·ªánh

	```sh
	swapoff -a
	````

- M·ªü file `/etc/fstab` v√† comment d√≤ng swap l·∫°i nh∆∞ ·∫£nh: http://prntscr.com/jd638u 
- Ki·ªÉm tra l·∫°i b·∫±ng l·ªánh `free -m` n·∫øu d√≤ng swap b√°o gi√° tr·ªã 0 l√† ƒë√£ t·∫Øt swap th√†nh c√¥ng, tham kh·∫£o: http://prntscr.com/jd63wk


- ƒê·∫∑t ip cho node `k8s-master` b·∫±ng c√°ch ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ s·ª≠a file file `/etc/network/interfaces`

  ```sh
  cat << EOF > /etc/network/interfaces
  # This file describes the network interfaces available on your system
  # and how to activate them. For more information, see interfaces(5).

  source /etc/network/interfaces.d/*

  # The loopback network interface
  auto lo
  iface lo inet loopback

  # The primary network interface
  auto ens4
  iface ens4 inet static
  address 172.16.68.130
  netmask 255.255.255.0
  gateway 172.16.68.1
  dns-nameservers 8.8.8.8
  EOF

- ƒê·∫∑t hostname cho m√°y `k8s-master` b·∫±ng c√°ch s·ª≠a n·ªôi dung c√°c file `/etc/hosts` v√† `/etc/hostname`
  - Ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ khai b√°o hostname cho `k8s-node1`
    ```sh
    cat << EOF > /etc/hosts
    127.0.0.1       localhost k8s-master
    172.16.68.130       k8s-master
    172.16.68.131       k8s-k8s-node1
    172.16.68.132       k8s-node2
    EOF
    ```
    
  - File `/etc/hostname` ƒë∆∞·ª£c s·ª≠a b·∫±ng l·ªánh d∆∞·ªõi.
    ```sh
    echo k8s-master > /etc/hostname
    ```
    
- Kh·ªüi ƒë·ªông l·∫°i node k8s-master
  ```sh
  init 6
  ```

#### 3.1. ƒê·∫∑t hostname v√† ip cho node `k8s-node1`
- Th·ª±c hi·ªán update v√† c√†i c√°c g√≥i b·ªï tr·ª£ cho OS.

  ```sh
  apt-get update -y && apt-get upgrade -y
  apt-get -y install -y vim curl wget 
  apt-get -y install byobu
  ```
T·∫Øt t√≠nh nƒÉng swap c·ªßa OS.

- Do K8S kh√¥ng h·ªó tr·ª£ swap n√™n c·∫ßn ph·∫£i t·∫Øt swap n·∫øu nh∆∞ trong l√∫c c√†i OS b·∫°n ƒë√£ c·∫•u h√¨nh, c√°c b∆∞·ªõc nh∆∞ sau.
Th·ª±c hi·ªán l·ªánh

	```sh
	swapoff -a
	````

- M·ªü file `/etc/fstab` v√† comment d√≤ng swap l·∫°i nh∆∞ ·∫£nh: http://prntscr.com/jd638u 
- Ki·ªÉm tra l·∫°i b·∫±ng l·ªánh `free -m` n·∫øu d√≤ng swap b√°o gi√° tr·ªã 0 l√† ƒë√£ t·∫Øt swap th√†nh c√¥ng, tham kh·∫£o: http://prntscr.com/jd63wk
- ƒê·∫∑t ip cho node `k8s-node1` b·∫±ng c√°ch ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ s·ª≠a file file `/etc/network/interfaces`

  ```sh
  cat << EOF > /etc/network/interfaces
  # This file describes the network interfaces available on your system
  # and how to activate them. For more information, see interfaces(5).

  source /etc/network/interfaces.d/*

  # The loopback network interface
  auto lo
  iface lo inet loopback

  # The primary network interface
  auto ens4
  iface ens4 inet static
  address 172.16.68.131
  netmask 255.255.255.0
  gateway 172.16.68.1
  dns-nameservers 8.8.8.8
  EOF
  ```

- ƒê·∫∑t hostname cho m√°y `k8s-master` b·∫±ng c√°ch s·ª≠a n·ªôi dung c√°c file `/etc/hosts` v√† `/etc/hostname`
  - Ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ khai b√°o hostname cho `k8s-node1`
    ```sh
    cat << EOF > /etc/hosts
    127.0.0.1       localhost k8s-node1
    172.16.68.130       k8s-master
    172.16.68.131       k8s-node1
    172.16.68.132       k8s-node2
    EOF
    ```
    
    ```sh
    echo k8s-node1 > /etc/hostname
    ```
    
- Kh·ªüi ƒë·ªông l·∫°i `k8s-node1`
  ```sh
  init 6
  ```

#### 3.2. ƒê·∫∑t hostname v√† ip cho node `k8s-node2`
- Th·ª±c hi·ªán update v√† c√†i c√°c g√≥i b·ªï tr·ª£ cho OS.

  ```sh
  apt-get update -y && apt-get upgrade -y
  apt-get -y install -y vim curl wget 
  apt-get -y install byobu
  ```
T·∫Øt t√≠nh nƒÉng swap c·ªßa OS.

- Do K8S kh√¥ng h·ªó tr·ª£ swap n√™n c·∫ßn ph·∫£i t·∫Øt swap n·∫øu nh∆∞ trong l√∫c c√†i OS b·∫°n ƒë√£ c·∫•u h√¨nh, c√°c b∆∞·ªõc nh∆∞ sau.
Th·ª±c hi·ªán l·ªánh

	```sh
	swapoff -a
	````

- M·ªü file `/etc/fstab` v√† comment d√≤ng swap l·∫°i nh∆∞ ·∫£nh: http://prntscr.com/jd638u 
- Ki·ªÉm tra l·∫°i b·∫±ng l·ªánh `free -m` n·∫øu d√≤ng swap b√°o gi√° tr·ªã 0 l√† ƒë√£ t·∫Øt swap th√†nh c√¥ng, tham kh·∫£o: http://prntscr.com/jd63wk
- ƒê·∫∑t ip cho node `k8s-node2` b·∫±ng c√°ch ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ s·ª≠a file file `/etc/network/interfaces`

  ```sh
  cat << EOF > /etc/network/interfaces
  # This file describes the network interfaces available on your system
  # and how to activate them. For more information, see interfaces(5).

  source /etc/network/interfaces.d/*

  # The loopback network interface
  auto lo
  iface lo inet loopback

  # The primary network interface
  auto ens4
  iface ens4 inet static
  address 172.16.68.132
  netmask 255.255.255.0
  gateway 172.16.68.1
  dns-nameservers 8.8.8.8
  EOF
  ```

- ƒê·∫∑t hostname cho m√°y `k8s-master` b·∫±ng c√°ch s·ª≠a n·ªôi dung c√°c file `/etc/hosts` v√† `/etc/hostname`
  - Ch·∫°y l·ªánh d∆∞·ªõi ƒë·ªÉ khai b√°o hostname cho `k8s-node2`
    ```sh
    cat << EOF > /etc/hosts
    127.0.0.1       localhost k8s-node2
    172.16.68.130       k8s-master
    172.16.68.131       k8s-node1
    172.16.68.132       k8s-node2
    EOF
    ```
    
  - File `/etc/hostname` ƒë∆∞·ª£c s·ª≠a b·∫±ng l·ªánh d∆∞·ªõi.
    ```sh
    echo k8s-node2 > /etc/hostname
    ```
    
- Kh·ªüi ƒë·ªông l·∫°i `k8s-node2`
  ```sh
  init 6
  ```

### 4. C√†i ƒë·∫∑t docker v√† c√°c th√†nh ph·∫ßn c·∫ßn thi·∫øt c·ªßa K8S.
Tr√™n t·∫•t c·∫£ c√°c node s·∫Ω c√†i c√°c th√†nh ph·∫ßn: `docker, kubelet, kubeadm v√† kubectl`. Trong ƒë√≥:
- `docker`: ƒë·ªÉ l√†m m√¥i tr∆∞·ªùng ch·∫°y c√°c container.
- `kubeadm`: ƒê∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ thi·∫øt l·∫≠p c·ª•m cluster cho K8S. (Cluster l√† m·ªôt c·ª•m m√°y th·ª±c hi·ªán chung m·ªôt m·ª•c ƒë√≠ch). C√°c t√†i li·ªáu chuy√™n m√¥n g·ªçi `kubeadm` l√† b·ªôt bootstrap (bootstrap t·∫°m hi·ªÉu m·ªôt tools ƒë√≥ng g√≥i ƒë·ªÉ t·ª± ƒë·ªông l√†m vi·ªác g√¨ ƒë√≥)
- `kubelet`: L√† th√†nh ph·∫ßn ch·∫°y tr√™n c√°c host, c√≥ nhi·ªám v·ª• k√≠ch ho·∫°t c√°c pod v√† container trong c·ª•m Cluser c·ªßa K8S.
- `kubectl`: L√† c√¥ng c·ª• cung c·∫•p CLI (Giao di·ªán d√≤ng l·ªánh) ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi K8S.

#### 4.1. C√†i ƒë·∫∑t docker tr√™n t·∫•t c·∫£ c√°c node 

```sh
apt-get -y update && apt-get -y install docker.io
```

#### 4.2. C√†i ƒë·∫∑t c√°c th√†nh ph·∫ßn c·ªßa K8S tr√™n t·∫•t c·∫£ c√°c node.

- C√†i ƒë·∫∑t tr√™n t·∫•t c·∫£ c√°c node  

```sh
apt-get update && apt-get install -y apt-transport-https

curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add 

cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF

apt-get update  -y
apt-get install -y kubelet kubeadm kubectl
```


#### 4.3 Thi·∫øt l·∫≠p cluster 

- ƒê·ª©ng tr√™n node `k8s-master` th·ª±c hi·ªán l·ªánh d∆∞·ªõi ƒë·ªÉ thi·∫øt l·∫≠p cluster

  ```sh
  kubeadm init --apiserver-advertise-address 172.16.68.130 --pod-network-cidr=10.244.0.0/16
  ```
  
- Trong ƒë√≥:
  - `172.16.68.130`: l√† IP c·ªßa node k8s-master

  `--apiserver-advertise-address`: l√† ƒë·ªãa ch·ªâ c·ªßa node k8s-master, ƒë·ªãa ch·ªâ n√†y c·∫ßn truy·ªÅn th√¥ng ƒë∆∞·ª£c v·ªõi c√°c node c√≤n l·∫°i trong c·ª•m cluster. Trong v√≠ d·ª• n√†y node k8s-master c√≥ ƒë·ªãa ch·ªâ l√†: 172.16.68.130.
	`--pod-network-cidr`: l√† d·∫£i ƒë·ªãa ch·ªâ m·∫°ng ph·ª• thu·ªôc m√† c√¥ng ngh·ªá network s·∫Ω s·ª≠ d·ª•ng khi k·∫øt h·ª£p v·ªõi K8S, trong h∆∞·ªõng d·∫´n n√†y ta s·ª≠ d·ª•ng flannet v√† flannet s·ª≠ d·ª•ng d·∫£i `10.244.0.0/16. `

- Sau khi ch·∫°y k·∫øt qu·∫£ nh∆∞ sau l√† th√†nh c√¥ng: http://paste.openstack.org/raw/720277/ (N·∫øu ch∆∞a ƒë√∫ng th√¨ ki·ªÉm tra l·∫°i t·ª´ ƒë·∫ßu nh√© üòâ) 
- L∆∞u √Ω quan tr·ªçng: Trong output ·ªü tr√™n c√≥ d√≤ng d∆∞·ªõi, s·ª≠ d·ª•ng d√≤ng n√†y ƒë·ªÉ join c√°c node k8s-node1 v√† k8s-node2 v√†o c·ª•m cluster ·ªü b∆∞·ªõc d∆∞·ªõi  (Kh√¥ng ch·∫°y l·ªánh n√†y ·ªü ƒë√¢y  - v√¨ ch·ªâ l√† note l∆∞u √Ω).
 
- Lu∆∞ √Ω: N·∫øu g·∫∑p th√¥ng b√°o l·ªói `[ERROR Swap]: running with swap on is not supported. Please disable swap`   khi th·ª±c hi·ªán `kubeadm init` th√¨ c·∫ßn th·ª±c hi·ªán l·ªánh `swapoff -a`. Sau ƒë√≥ th·ª±c hi·ªán l·∫°i l·ªánh ·ªü tr√™n.

- K·∫øt qu·∫£ c·ªßa l·ªánh tr√™n nh∆∞ b√™n d∆∞·ªõi ho·∫∑c nh∆∞ ·∫£nh http://prntscr.com/i5icxv

  ```sh
  root@k8s-master:~#   kubeadm init --apiserver-advertise-address 172.16.68.130 --pod-network-cidr=10.244.0.0/16
  [init] Using Kubernetes version: v1.9.2
  [init] Using Authorization modes: [Node RBAC]
  [preflight] Running pre-flight checks.
          [WARNING FileExisting-crictl]: crictl not found in system path
  [certificates] Generated ca certificate and key.
  [certificates] Generated apiserver certificate and key.
  [certificates] apiserver serving cert is signed for DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 172.16.68.130]
  [certificates] Generated apiserver-kubelet-client certificate and key.
  [certificates] Generated sa key and public key.
  [certificates] Generated front-proxy-ca certificate and key.
  [certificates] Generated front-proxy-client certificate and key.
  [certificates] Valid certificates and keys now exist in "/etc/kubernetes/pki"
  [kubeconfig] Wrote KubeConfig file to disk: "admin.conf"
  [kubeconfig] Wrote KubeConfig file to disk: "kubelet.conf"
  [kubeconfig] Wrote KubeConfig file to disk: "controller-manager.conf"
  [kubeconfig] Wrote KubeConfig file to disk: "scheduler.conf"
  [controlplane] Wrote Static Pod manifest for component kube-apiserver to "/etc/kubernetes/manifests/kube-apiserver.yaml"
  [controlplane] Wrote Static Pod manifest for component kube-controller-manager to "/etc/kubernetes/manifests/kube-controller-manager.yaml"
  [controlplane] Wrote Static Pod manifest for component kube-scheduler to "/etc/kubernetes/manifests/kube-scheduler.yaml"
  [etcd] Wrote Static Pod manifest for a local etcd instance to "/etc/kubernetes/manifests/etcd.yaml"
  [init] Waiting for the kubelet to boot up the control plane as Static Pods from directory "/etc/kubernetes/manifests".
  [init] This might take a minute or longer if the control plane images have to be pulled.
  [apiclient] All control plane components are healthy after 56.503430 seconds
  [uploadconfig]¬†Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
  [markk8s-master] Will mark node k8s-master as k8s-master by adding a label and a taint
  [markk8s-master] k8s-master k8s-master tainted and labelled with key/value: node-role.kubernetes.io/k8s-master=""
  [bootstraptoken] Using token: 1aeb1d.89a15bf6272c8274
  [bootstraptoken] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
  [bootstraptoken] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
  [bootstraptoken] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
  [bootstraptoken] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
  [addons] Applied essential addon: kube-dns
  [addons] Applied essential addon: kube-proxy

  Your Kubernetes k8s-master has initialized successfully!

  To start using your cluster, you need to run the following as a regular user:

    mkdir -p $HOME/.kube
    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    sudo chown $(id -u):$(id -g) $HOME/.kube/config

  You should now deploy a pod network to the cluster.
  Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
    https://kubernetes.io/docs/concepts/cluster-administration/addons/

  You can now join any number of machines by running the following on each node
  as root:

    kubeadm join --token 1aeb1d.89a15bf6272c8274 172.16.68.130:6443 --discovery-token-ca-cert-hash sha256:cb8e0cd1238dc8fe8b1b2f16fe02817425005f04a8ddd09a7c19db08b75f72eb

  root@k8s-master:~#
  ```

- Quan s√°t c·ªßa s·ªï ssh v√† th·ª±c hi·ªán theo th√¥ng b√°o, th·ª±c hi·ªán ti·∫øp tr√™n node `k8s-master` ƒë·ªÉ c·∫•u h√¨nh `kubectl` cho node k8s-master.

- T·ªõi b∆∞·ªõc n√†y ta c√≥ 02 l·ª±a ch·ªçn ƒë·ªÉ thao t√°c v·ªõi K8S, l·ª±a ch·ªçn 1 l√† s·ª≠ d·ª•ng t√†i kho·∫£n `root`, l·ª±a ch·ªçn 2 l√† s·ª≠ d·ª•ng m·ªôt t√†i kho·∫£n kh√°c, h∆∞·ªõng d·∫´n n√†y l√† t√†i kho·∫£n `ubuntu`.

#### L·ª±a chon 1: S·ª≠ d·ª•ng t√†i kho·∫£n `root` ƒë·ªÉ thao t√°c v·ªõi `K8S`
- Trong m·ªói phi√™n ssh b·∫±ng t√†i kho·∫£n `root`, ƒë·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c l·ªánh c·ªßa K8S th√¨ c·∫ßn th·ª±c hi·ªán l·ªánh d∆∞·ªõi ƒë·ªÉ khai b√°o c√°c bi·∫øn m√¥i tr∆∞·ªùng

  ```sh
  export KUBECONFIG=/etc/kubernetes/admin.conf
  ```
    - Sau ƒë√≥ c√≥ th·ªÉ thao t√°c c√°c v·ªõi c√°c l·ªánh c·ªßa K8S ·ªü b√™n d∆∞·ªõi sau khi ho√†n t·∫•t vi·ªác c√†i ƒë·∫∑t.

- Ho·∫∑c khai b√°o c·ªë ƒë·ªãnh bi·∫øn m√¥i tr∆∞·ªùng b·∫±ng c√°c l·ªánh d∆∞·ªõi ƒë√¢y. L√∫c n√†y ta kh√¥ng c·∫ßn th·ª±c hi·ªán export nh∆∞ ·ªü tr√™n n·ªØa.

	```
	mkdir -p $HOME/.kube
	sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
	sudo chown $(id -u):$(id -g) $HOME/.kube/config
	```
    
#### L·ª±a chon 2: S·ª≠ d·ª•ng m·ªôt t√†i kho·∫£n kh√°c t√†i kho·∫£n `root`
- T·∫°o user `ubuntu` ƒë·ªÉ th·ª±c hi·ªán c·∫•u h√¨nh cho K8S. N·∫øu c√≥ user tr∆∞·ªõc ƒë√≥ r·ªìi th√¨ kh√¥ng c·∫ßn th·ª±c hi·ªán b∆∞·ªõc n√†y.

  ```sh
  adduser ubuntu
  ```

- Nh·∫≠p th√¥ng tin v√† m·∫≠t kh·∫©u cho user `ubuntu`, sau ƒë√≥ ph√¢n quy·ªÅn sudoer b·∫±ng l·ªánh d∆∞·ªõi.

  ```sh
  echo "ubuntu ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
  ```
  
- Chuy·ªÉn sang user ubuntu ƒë·ªÉ th·ª±c hi·ªán.

  ```sh
  su - ubuntu
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
  ```

- S·ª≠ d·ª•ng th·ªß thu·∫≠t d∆∞·ªõi ƒë·ªÉ thao t√°c l·ªánh trong k8s ƒë∆∞·ª£c thu·∫≠n l·ª£i h∆°n nh·ªù vi·ªác t∆∞ ƒë·ªông ho√†n thi·ªán l·ªánh m·ªói khi thao t√°c.

```sh
echo "source <(kubectl completion bash)" >> ~/.bashrc
```

#### 4.4 C√†i ƒë·∫∑t Pod Network 

- ƒê·ª©ng tr√™n node k8s-master c√†i ƒë·∫∑t Pod network.
- K8S c√≥ nhi·ªÅu l·ª±a ch·ªçn cho gi·∫£i ph√°p network ƒë·ªÉ k·∫øt n·ªëi c√°c container, trong h∆∞·ªõng d·∫´n n√†y ch√∫ng t√¥i s·ª≠ d·ª•ng `flannel`

  ```sh
	kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
  ```

  - K·∫øt qu·∫£ c·ªßa l·ªánh tr√™n nh∆∞ sau: 

    ```sh
		root@k8s-master:~# kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
		clusterrole.rbac.authorization.k8s.io "flannel" created
		clusterrolebinding.rbac.authorization.k8s.io "flannel" created
		serviceaccount "flannel" created
		configmap "kube-flannel-cfg" created
		daemonset.extensions "kube-flannel-ds" created
		```

- T·ª´ b·∫£n 1.9 tr·ªü l√™n, th·ª±c hi·ªán l·ªánh d∆∞·ªõi ƒë·ªÉ t·∫°o token tr√™n node k8s-master, k·∫øt qu·∫£ tr·∫£ v√™ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ th·ª±c hi·ªán tr√™n c√°c k8s-node1 v√† k8s-node2

  ```sh
   sudo kubeadm token create --print-join-command
  ```
  - K·∫øt qu·∫£ nh∆∞ b√™n d∆∞·ªõi, l∆∞u gi√° tr·ªã trong c·ªôt token ƒë·ªÉ s·ª≠ d·ª•ng cho vi·ªác join c√°c k8s-node1 v√† k8s-node2 v√†o c·ª•m cluster:
    ```sh
    kubeadm join --token 150984.0da1fe160e5113f0 172.16.68.130:6443 --discovery-token-ca-cert-hash sha256:cb8e0cd1238dc8fe8b1b2f16fe02817425005f04a8ddd09a7c19db08b75f72eb
    ```
- Sau ƒë√≥ d√πng k·∫øt qu·∫£ tr√™n ƒë·ªÉ copy v√† th·ª±c hi·ªán tr√™n c√°c k8s-node1 v√† k8s-node2.
    
#### 4.5. Th·ª±c hi·ªán join `k8s-node1` v√† `k8s-node2` v√†o cluster
- ƒê·ª©ng tr√™n c·∫£ `k8s-node1` v√† `k8s-node2` th·ª±c hi·ªán 
  ```sh
  kubeadm join --token 150984.0da1fe160e5113f0 172.16.68.130:6443 --discovery-token-ca-cert-hash sha256:cb8e0cd1238dc8fe8b1b2f16fe02817425005f04a8ddd09a7c19db08b75f72eb
  ````
  
- L∆∞u √Ω: N·∫øu c√≥ th√¥ng b√°o `[ERROR Swap]: running with swap on is not supported. Please disable swap` khi th·ª±c hi·ªán l·ªánh join th√¨ s·ª≠ d·ª•ng l·ªánh d∆∞·ªõi v√† th·ª±c hi·ªán l·∫°i l·ªánh join.
  ```sh
  swapoff -a
  ```
  
- K·∫øt qu·∫£ tr·∫£ v·ªÅ l√†:
  ```sh
  [preflight] Running pre-flight checks.
          [WARNING FileExisting-crictl]: crictl not found in system path
  [discovery] Trying to connect to API Server "172.16.68.130:6443"
  [discovery] Created cluster-info discovery client, requesting info from "https://172.16.68.130:6443"
  [discovery] Requesting info from "https://172.16.68.130:6443" again to validate TLS against the pinned public key
  [discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server "172.16.68.130:6443"
  [discovery] Successfully established connection with API Server "172.16.68.130:6443"

  This node has joined the cluster:
  * Certificate signing request was sent to k8s-master and a response
    was received.
  * The Kubelet was informed of the new secure connection details.

  Run 'kubectl get nodes' on the k8s-master to see this node join the cluster.
  root@k8s-node1:~#
  ```

- `L∆∞u √Ω`: l√† c·∫ßn th·ª±c hi·ªán tr√™n c·∫£ 02 node `k8s-node1` v√† `k8s-node2`

- Sau khi th·ª±c hi·ªán join c·∫£ 02 `k8s-node1` v√† `k8s-node2` th√¨ quay l·∫°i node `k8s-master` ƒë·ªÉ ki·ªÉm tra c√°c node xem ƒë√£ join ƒë∆∞·ª£c hay ch∆∞a.
  ```sh
  export KUBECONFIG=/etc/kubernetes/admin.conf
  kubectl get nodes
  ```

- K·∫øt qu·∫£ tr·∫£ v·ªÅ c·ªßa l·ªánh tr√™n nh∆∞ sau.
  ```sh
  NAME      STATUS    ROLES     AGE       VERSION
  k8s-master    Ready     k8s-master    9h        v1.9.2
  k8s-node1     Ready     <none>    8h        v1.9.2
  k8s-node2     Ready     <none>    6m        v1.9.2
  ```

Ch√∫ng ta c√≥ th·ªÉ th·∫•y ·ªü c·ªôt `STATUS` ƒë√£ c√≥ tr·∫°ng th√°i `Ready`. Ti·∫øp t·ª•c th·ª±c hi·ªán hi·ªán l·ªánh d∆∞·ªõi ƒë·ªÉ download ho·∫∑c ki·ªÉm tra tr·∫°ng th√°i c·ªßa c√°c th√†nh ph·∫ßn trong K8S tr√™n c√°c node ƒë√£ ho·∫°t ƒë·ªông hay ch∆∞a.

  ```sh
  kubectl get pod --all-namespaces
  ```

- K·∫øt qu·∫£ nh∆∞ b√™n d∆∞·ªõi l√† ok (ki·ªÉm tra c·ªôt `STATUS`). 

  ```sh
  NAMESPACE     NAME                             READY     STATUS    RESTARTS   AGE
  kube-system   etcd-k8s-master                      1/1       Running   0          9h
  kube-system   kube-apiserver-k8s-master            1/1       Running   0          9h
  kube-system   kube-controller-manager-k8s-master   1/1       Running   0          9h
  kube-system   kube-dns-6f4fd4bdf-ctxx7         3/3       Running   0          9h
  kube-system   kube-flannel-ds-kjnhs            1/1       Running   0          9h
  kube-system   kube-flannel-ds-wz648            1/1       Running   0          8h
  kube-system   kube-flannel-ds-xtcj9            1/1       Running   0          36m
  kube-system   kube-proxy-5slwp                 1/1       Running   0          36m
  kube-system   kube-proxy-5trrj                 1/1       Running   0          9h
  kube-system   kube-proxy-b54bs                 1/1       Running   0          8h
  kube-system   kube-scheduler-k8s-master            1/1       Running   0          9h
  ```

- Trong m·ªôt v√†i tr∆∞·ªùng h·ª£p c·ªôt `STATUS` s·∫Ω c√≥ tr·∫°ng th√°i `Pending, ContainerCreating,ImagePullBackOf` ƒë·ªëi v·ªõi m·ªôt s·ªë th√†nh ph·∫ßn, c√≥ th·ªÉ ch·ªù ho·∫∑c ki·ªÉm tra b·∫±ng l·ªánh `kubectl describe pod <ten_pod> --namespace=kube-system` , ·ªü ƒë√¢y t√™n pod ƒë∆∞·ª£c l·∫•y t·ª´ c·ªôt `NAME`.
 
		```sh
		export KUBECONFIG=/etc/kubernetes/admin.conf
		kubectl describe pod kube-scheduler-k8s-master --namespace=kube-system
		```

- K·∫øt qu·∫£: http://paste.openstack.org/raw/653532/
  
T·ªõi ƒë√¢y ch√∫ng ta ƒë√£ c√≥ m√¥i tr∆∞·ªùng ƒë·ªÉ b·∫Øt ƒë·∫ßu th·ª±c h√†nh v·ªõi K8S r·ªìi. Sau ph·∫ßn n√†y ch√∫ng ta n√™n ƒë·ªçc sang ph·∫ßn c√°c kh√°i ni·ªám trong K8S tr∆∞·ªõc khi ƒëi v√†o th·ª±c h√†nh chi ti·∫øt h∆°n.


### Ch·∫°y th·ª≠ ·ª©ng d·ª•ng 

- Ch·∫°y th·ª≠ ·ª©ng d·ª•ng l√† ngnix ƒë·ªÉ ki·ªÉm tra ho·∫°t ƒë·ªông c·ªßa c·ª•m cluster. Trong l·ªánh n√†y s·∫Ω t·∫°o ra 02 container ch·∫°y nginx v√† t·ª± ƒë·ªông ph√¢n t√°n tr√™n c√°c node k8s-node1 v√† k8s-node2. 

		```sh
		kubectl run test-nginx --image=nginx --replicas=2 --port=80
		```

  - K·∫øt qu·∫£ c·ªßa l·ªánh tr√™n: http://prntscr.com/jd7mj9 
  
Ki·ªÉm tra xem trang th√°i c·ªßa c√°c container 

		```sh
		kubectl get pods -o wide
		```

		- K·∫øt qu·∫£ c·ªßa l·ªánh tr√™n:  http://prntscr.com/jd7nol (l∆∞u √Ω c·ªôt STATUS v√† NODE)

- ƒê·ªëi v·ªõi l·ªánh tr√™n ta ch·ªâ c√≥ th·ªÉ truy c·∫≠p v√†o web server nginx s·∫Ω ƒë∆∞·ª£c t·∫°o trong c√°c container b·∫±ng c√°c ƒë·ªãa ch·ªâ private v√¨ port ch∆∞a ƒë∆∞·ª£c √°nh x·∫° ra ngo√†i, n·∫øu mu·ªën s·ª≠ d·ª•ng IP c·ªßa c√°c m√°y k8s-k8s-master, k8s-k8s-node1, k8s-k8s-node2 th√¨ ta c·∫ßn s·ª≠ d·ª•ng t√πy ch·ªçn sau

		```sh
		kubectl expose deploy test-nginx --port 80 --target-port 80 --type NodePort
		```

  - Tuy nhi√™n, port 80 ·ªü tr√™n ch·ªâ l√† port ƒë·ªÉ c√°c node √°nh x·∫° t·ªõi, mu·ªën bi·∫øt port ƒë·ªÉ k·∫øt h·ª£p v·ªõi ƒë·ªãa ch·ªâ IP c·ªßa c√°c node ta c·∫ßn xem trong d√≤ng NodePort http://prntscr.com/jd84mp ·ªü k·∫øt qu·∫£ c·ªßa l·ªánh d∆∞·ªõi.

- Ki·ªÉm tra th√¥ng tin sau khi deploy

		```sh
		kubectl describe service test-nginx
		```

  - K·∫øt qu·∫£ s·∫Ω hi·ªán th·ªã th√¥ng tin c·ªßa c√°c ·ª©ng d·ª•ng ƒë√£ ƒë∆∞·ª£c deploy: http://prntscr.com/jd7otc .
  - C√≥ th·ªÉ chuy·ªÉn sang c√°c node k8s-k8s-node1 v√† k8s-k8s-node2 ƒë·ªÉ ki·ªÉm tra c√°c container b·∫±ng l·ªánh docker ps 
 
- ƒê·ªÉ delete ·ª©ng d·ª•ng v·ª´a t·∫°o ta s·ª≠ d·ª•ng c√°c l·ªánh d∆∞·ªõi

		```sh
		kubectl delete service test-nginx

		kubectl delete deployment test-nginx
		```

- Sau ƒë√≥ ki·ªÉm tra l·∫°i b·∫±ng l·ªánh 

		```sh
		kubectl get services
		kubectl get deployments
		```

T·ªõi ƒë√¢y vi·ªác d·ª±ng c·ª•m cluster K8S ƒë√£ ho√†n t·∫•t, chuy·ªÉn sang c√°c b∆∞·ªõc t√¨m hi·ªÉu n√¢ng cao nh√©.

